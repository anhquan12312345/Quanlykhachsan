<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lá»‹ch sá»­ Äáº·t phÃ²ng - KhÃ¡ch sáº¡n NhÃ³m 11</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background-image: url('/images/Gemini_Generated_Image_p6w099p6w099p6w0.png'); 
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            font-family: 'Inter', sans-serif;
        }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
    </style>
</head>
<body class="text-gray-800">

    <header class="fixed top-0 left-0 w-full bg-white text-gray-800 shadow-md z-50">
        <div class="max-w-6xl mx-auto flex justify-between items-center p-4">
            
            <div class="flex items-center space-x-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-700"><rect width="16" height="20" x="4" y="2" rx="2" ry="2"/><path d="M9 22v-4h6v4"/><path d="M8 6h.01"/><path d="M16 6h.01"/><path d="M12 6h.01"/><path d="M12 10h.01"/><path d="M12 14h.01"/><path d="M16 10h.01"/><path d="M16 14h.01"/><path d="M8 10h.01"/><path d="M8 14h.01"/></svg>
                <span class="text-2xl font-bold text-blue-700">KhÃ¡ch sáº¡n NhÃ³m 11</span>
            </div>

            <div id="userMenu" class="flex items-center space-x-4">
                <span id="welcomeMessage" class="font-semibold text-gray-700 hidden md:block"></span>    
                <div class="flex items-center space-x-2"> 
                    <a href="./trang_dat_phong.html" class="bg-green-600 text-white px-4 py-2 rounded-xl font-semibold hover:bg-blue-700 transition-colors"> Quay láº¡i
                    </a>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <main class="pt-20">
        <section class="py-16 bg-white/95 backdrop-blur-sm min-h-screen">
            <div class="max-w-4xl mx-auto px-4"> <h2 class="text-3xl font-bold text-center mb-12 text-gray-800">Lá»‹ch sá»­ Äáº·t phÃ²ng cá»§a Báº¡n</h2>

                <div id="myBookingsList" class="space-y-6">
                    </div>
                
                <p id="loadingMessage" class="text-center text-gray-600 text-lg mt-8">Äang táº£i lá»‹ch sá»­ Ä‘áº·t phÃ²ng...</p>
    </main> 
    <div class="mt-10 py-6 border-t border-gray-300 bg-white/80 backdrop-blur-sm text-center">
        <p class="text-gray-700 font-semibold text-lg">
            QuÃ½ khÃ¡ch muá»‘n há»§y phÃ²ng xin vui lÃ²ng liÃªn há»‡ SÄT: 
            <a class="text-red-600 font-bold hover:underline">088999 1111</a>
        </p>
            </div>
        </section>
    </main>

    <script>
        const welcomeMessage = document.getElementById('welcomeMessage'); // Äáº£m báº£o ID nÃ y Ä‘Ãºng vá»›i HTML cá»§a báº¡n
        const bookingsList = document.getElementById('myBookingsList');   // Äáº£m báº£o ID nÃ y Ä‘Ãºng vá»›i khung chá»©a danh sÃ¡ch
        const loadingMessage = document.getElementById('loadingMessage'); // Äáº£m báº£o ID nÃ y Ä‘Ãºng vá»›i dÃ²ng thÃ´ng bÃ¡o "Äang táº£i"
        
        // --- 1. CHáº Y KHI VÃ€O TRANG ---
        document.addEventListener('DOMContentLoaded', () => {
            const userStr = localStorage.getItem('currentUser');
            
            if (!userStr) {
                alert("Vui lÃ²ng Ä‘Äƒng nháº­p!");
                window.location.href = "Trangchu.html"; // Chuyá»ƒn vá» trang chá»§ náº¿u chÆ°a Ä‘Äƒng nháº­p
                return;
            }

            const currentUser = JSON.parse(userStr);

            // --- Sá»¬A Lá»–I "UNDEFINED" á» ÄÃ‚Y ---
            // Code nÃ y sáº½ tá»± mÃ² xem Server lÆ°u tÃªn lÃ  'Ten' hay 'hoTen' Ä‘á»ƒ láº¥y cho Ä‘Ãºng
            const userName = currentUser.Ten || currentUser.hoTen || currentUser.name || "KhÃ¡ch hÃ ng";
            const userId = currentUser.Id || currentUser.id || currentUser.ID;

            // Hiá»ƒn thá»‹ tÃªn (Náº¿u HTML cá»§a báº¡n cÃ³ chá»— hiá»‡n tÃªn)
            if (welcomeMessage) welcomeMessage.textContent = `ChÃ o, ${userName}`;

            // Gá»i server láº¥y lá»‹ch sá»­
            if (userId) {
                fetchMyBookings(userId);
            } else {
                console.error("Lá»—i: KhÃ´ng tÃ¬m tháº¥y ID ngÆ°á»i dÃ¹ng");
            }

            // Xá»­ lÃ½ nÃºt Ä‘Äƒng xuáº¥t (Náº¿u cÃ³ nÃºt ID="btnLogout")
            const btnLogout = document.getElementById('btnLogout');
            if (btnLogout) {
                btnLogout.addEventListener('click', () => {
                    localStorage.removeItem('currentUser');
                    window.location.href = "Trangchu.html";
                });
            }
        });

        // --- 2. HÃ€M Táº¢I Dá»® LIá»†U ---
        async function fetchMyBookings(userId) {
            try {
                const res = await fetch(`http://localhost:3000/my-bookings/${userId}`);
                if (!res.ok) throw new Error("Lá»—i káº¿t ná»‘i Server");
                
                const bookings = await res.json();
                
                if (bookings.length === 0) {
                    if(loadingMessage) loadingMessage.textContent = "Báº¡n chÆ°a cÃ³ Ä‘Æ¡n Ä‘áº·t phÃ²ng nÃ o.";
                } else {
                    if(loadingMessage) loadingMessage.style.display = 'none'; // áº¨n chá»¯ Ä‘ang táº£i
                    renderBookings(bookings);
                }
            } catch (err) {
                console.error(err);
                if(loadingMessage) {
                    loadingMessage.textContent = "KhÃ´ng thá»ƒ táº£i dá»¯ liá»‡u (Kiá»ƒm tra láº¡i Server).";
                    loadingMessage.style.color = "red";
                }
            }
        }

        // --- 3. HÃ€M HIá»‚N THá»Š DANH SÃCH ---
// --- 3. HÃ€M HIá»‚N THá»Š DANH SÃCH (Chá»‰ xem, khÃ´ng há»§y) ---
function renderBookings(bookings) {
    if (!bookingsList) return;
    bookingsList.innerHTML = "";

    bookings.forEach(item => {
        // 1. Format ngÃ y
        const checkIn = new Date(item.CheckIn).toLocaleDateString('vi-VN');
        const checkOut = new Date(item.CheckOut).toLocaleDateString('vi-VN');

        // 2. Format thá»i gian Ä‘áº·t
        let orderTime = 'Vá»«a xong';
        if (item.NgayDat) {
            orderTime = new Date(item.NgayDat).toLocaleString('vi-VN', {
                hour: '2-digit', minute: '2-digit',
                day: '2-digit', month: '2-digit', year: 'numeric'
            });
        }

        // 3. Xá»­ lÃ½ tráº¡ng thÃ¡i
        let colorClass = "text-gray-600"; 
        let statusIcon = "ğŸ”–";
        let statusText = item['Tráº¡ng ThÃ¡i'] || item.TrangThai || 'ChÆ°a xÃ¡c Ä‘á»‹nh';

        if (statusText === 'ÄÃ£ Ä‘áº·t') {
            colorClass = "text-blue-600 font-bold";
            statusIcon = "ğŸ“…";
        } else if (statusText === 'Äang á»Ÿ') {
            colorClass = "text-green-600 font-bold";
            statusIcon = "ğŸ ";
        } else if (statusText === 'ÄÃ£ thanh toÃ¡n') {
            colorClass = "text-purple-600 font-bold";
            statusIcon = "âœ…";
        } else if (statusText === 'ÄÃ£ há»§y') {
            colorClass = "text-red-600 font-bold";
            statusIcon = "âŒ";
        }

        // 4. HTML (KhÃ´ng cÃ³ nÃºt há»§y)
        const html = `
            <div class="bg-white p-5 rounded-lg shadow-md border-l-4 ${
                statusText === 'ÄÃ£ Ä‘áº·t' ? 'border-blue-500' :
                statusText === 'Äang á»Ÿ' ? 'border-green-500' :
                statusText === 'ÄÃ£ thanh toÃ¡n' ? 'border-purple-500' : 'border-gray-300'
            } mb-4 hover:shadow-xl transition">
                <div>
                    <div class="flex items-center mb-2">
                        <h3 class="font-bold text-xl text-gray-800 mr-2">${item.RoomName}</h3>
                        <span class="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded border">${item.RoomCode || 'N/A'}</span>
                    </div>
                    
                    <p class="text-xs text-gray-500 mb-3 italic">
                        ğŸ• Äáº·t lÃºc: ${orderTime}
                    </p>

                    <div class="text-sm text-gray-700 space-y-1">
                        <p>ğŸ“… <b>${checkIn}</b> <span class="text-gray-400 mx-1">â†’</span> <b>${checkOut}</b></p>
                        <p>ğŸ’° Tá»•ng tiá»n: <b class="text-red-600 text-lg">${item.TotalPrice}</b></p>
                        <p>${statusIcon} Tráº¡ng thÃ¡i: <span class="${colorClass}">${statusText}</span></p>
                    </div>
                </div>
            </div>
        `;
        bookingsList.innerHTML += html;
    });
}
    </script>
</body>
</html>