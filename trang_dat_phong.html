<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Đặt phòng - Khách sạn Nhóm 11</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      /* Sử dụng cùng ảnh nền và font chữ như trang chủ */
      background-image: url('Gemini_Generated_Image_p6w099p6w099p6w0.png'); 
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      background-attachment: fixed;
      font-family: 'Inter', sans-serif;
    }
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');

    /* Ẩn mũi tên của input number */
    input[type=number]::-webkit-inner-spin-button, 
    input[type=number]::-webkit-outer-spin-button { 
      -webkit-appearance: none; 
      margin: 0; 
    }
    input[type=number] {
      -moz-appearance: textfield;
    }
  </style>
</head>
<body class="text-gray-800">

  <!-- HEADER CỐ ĐỊNH (Tương tự trang chủ) -->
  <header class="fixed top-0 left-0 w-full bg-white text-gray-800 shadow-md z-50">
    <div class="max-w-6xl mx-auto flex justify-between items-center p-4">
      
      <!-- Logo và Tên khách sạn -->
      <div class="flex items-center space-x-2">
        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-700"><rect width="16" height="20" x="4" y="2" rx="2" ry="2"/><path d="M9 22v-4h6v4"/><path d="M8 6h.01"/><path d="M16 6h.01"/><path d="M12 6h.01"/><path d="M12 10h.01"/><path d="M12 14h.01"/><path d="M16 10h.01"/><path d="M16 14h.01"/><path d="M8 10h.01"/><path d="M8 14h.01"/></svg>
        <span class="text-2xl font-bold text-blue-700">Khách sạn Nhóm 11</span>
      </div>

      <!-- SỬA: Menu người dùng sau khi đăng nhập -->
      <div id="userMenu" class="flex items-center space-x-4">
        <span id="welcomeMessage" class="font-semibold text-gray-700 hidden md:block"></span>
        <button id="btnLogout" class="bg-blue-600 text-white px-4 py-2 rounded-xl font-semibold hover:bg-blue-700 transition-colors">Đăng xuất</button>
      </div>
    </div>
  </header>

  <!-- NỘI DUNG CHÍNH (BẮT ĐẦU SAU HEADER) -->
  <main class="pt-20"> <!-- Thêm padding top để không bị header che -->

    <!-- Section Đặt phòng (Sử dụng style nền mờ) -->
    <section class="py-16 bg-white/95 backdrop-blur-sm min-h-screen">
      <div class="max-w-6xl mx-auto px-4">
        <h2 class="text-3xl font-bold text-center mb-12 text-gray-800">Chọn Phòng Của Bạn</h2>

        <!-- BỐ CỤC 2 CỘT: DANH SÁCH PHÒNG (TRÁI) VÀ FORM (PHẢI) -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

          <!-- CỘT TRÁI: DANH SÁCH PHÒNG -->
          <div class="lg:col-span-2 space-y-6">

            <!-- Card Phòng Tổng thống -->
            <div class="bg-white rounded-2xl shadow-lg overflow-hidden flex flex-col md:flex-row transition-shadow hover:shadow-xl">
              <!-- Ảnh phòng -->
              <img src="Gemini_Generated_Image_ypf8z3ypf8z3ypf8.png" alt="Phòng Tổng thống" class="w-full md:w-1/3 h-60 md:h-auto object-cover">
              <!-- Thông tin phòng -->
              <div class="p-6 flex flex-col justify-between w-full">
                <div>
                  <h3 class="text-2xl font-semibold mb-2 text-blue-700">Phòng Tổng thống</h3>
                  <p class="text-gray-600 mb-4">Đỉnh cao của sự xa hoa. 100m², quản gia riêng, hồ bơi riêng, tầm nhìn cao, view hướng sông Hương, miễn phí toàn bộ dịch vụ.</p>
                </div>
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mt-4">
                  <span class="text-2xl font-bold text-gray-900 mb-3 md:mb-0">15.000.000 VNĐ<span class="text-sm font-normal text-gray-600"> / đêm</span></span>
                  <!-- Thêm data-* để JS lấy thông tin -->
                  <button 
                    class="btn-select-room bg-blue-600 text-white py-2 px-5 rounded-xl font-semibold hover:bg-blue-700 transition-colors"
                    data-room-id="P001"
                    data-room-name="Phòng Tổng thống"
                    data-room-price="15000000">
                    Chọn phòng này
                  </button>
                </div>
              </div>
            </div>

            <!-- Card Phòng Gia đình -->
            <div class="bg-white rounded-2xl shadow-lg overflow-hidden flex flex-col md:flex-row transition-shadow hover:shadow-xl">
              <img src="Gemini_Generated_Image_mydp7pmydp7pmydp.png" alt="Phòng Suite" class="w-full md:w-1/3 h-60 md:h-auto object-cover">
              <div class="p-6 flex flex-col justify-between w-full">
                <div>
                  <h3 class="text-2xl font-semibold mb-2 text-blue-700">Phòng Suite Gia Đình</h3>
                  <p class="text-gray-600 mb-4">Rộng rãi với 1 giường Queen, 1 giường tầng. Lý tưởng cho gia đình, 50m².</p>
                </div>
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mt-4">
                  <span class="text-2xl font-bold text-gray-900 mb-3 md:mb-0">5.000.000 VNĐ<span class="text-sm font-normal text-gray-600"> / đêm</span></span>
                  <button 
                    class="btn-select-room bg-blue-600 text-white py-2 px-5 rounded-xl font-semibold hover:bg-blue-700 transition-colors"
                    data-room-id="P002"
                    data-room-name="Phòng Suite Gia Đình"
                    data-room-price="5000000">
                    Chọn phòng này
                  </button>
                </div>
              </div>
            </div>

             <!-- Card Phòng DELUXE -->
            <div class="bg-white rounded-2xl shadow-lg overflow-hidden flex flex-col md:flex-row transition-shadow hover:shadow-xl">
              <img src="Gemini_Generated_Image_qw2uxzqw2uxzqw2u.png" alt="Phòng Deluxe" class="w-full md:w-1/3 h-60 md:h-auto object-cover">
              <div class="p-6 flex flex-col justify-between w-full">
                <div>
                  <h3 class="text-2xl font-semibold mb-2 text-blue-700">Phòng Deluxe</h3>
                  <p class="text-gray-600 mb-4">Tiện nghi, thoải mái, sang trọng. Giường Queen, 28m², view hướng sông Hương, miễn phí buffet sáng, phòng tập gym.</p>
                </div>
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mt-4">
                  <span class="text-2xl font-bold text-gray-900 mb-3 md:mb-0">3.00.000 VNĐ<span class="text-sm font-normal text-gray-600"> / đêm</span></span>
                  <button 
                    class="btn-select-room bg-blue-600 text-white py-2 px-5 rounded-xl font-semibold hover:bg-blue-700 transition-colors"
                    data-room-id="P003"
                    data-room-name="Phòng Deluxe"
                    data-room-price="3000000">
                    Chọn phòng này
                  </button>
                </div>
              </div>
            </div>

            <!-- THÊM CARD PHÒNG ĐÔi -->
            <div class="bg-white rounded-2xl shadow-lg overflow-hidden flex flex-col md:flex-row transition-shadow hover:shadow-xl">
              <img src="Gemini_Generated_Image_qw2uxzqw2uxzqw2u.png" alt="Phòng Standard" class="w-full md:w-1/3 h-60 md:h-auto object-cover">
              <div class="p-6 flex flex-col justify-between w-full">
                <div>
                  <h3 class="text-2xl font-semibold mb-2 text-blue-700">Phòng Cặp Đôi</h3>
                  <p class="text-gray-600 mb-4">Thoải mái, sang trọng, riêng tư. Miễn phí buffet sáng, tặng voucher 200k cho Sky bar </p>
                </div>
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mt-4">
                  <span class="text-2xl font-bold text-gray-900 mb-3 md:mb-0">2.000.000 VNĐ<span class="text-sm font-normal text-gray-600"> / đêm</span></span>
                  <button 
                    class="btn-select-room bg-blue-600 text-white py-2 px-5 rounded-xl font-semibold hover:bg-blue-700 transition-colors"
                    data-room-id="P004"
                    data-room-name="Phòng Standard"
                    data-room-price="2000000">
                    Chọn phòng này
                  </button>
                </div>
              </div>
            </div>

            <!-- CARD PHÒNG ĐƠN -->
            <div class="bg-white rounded-2xl shadow-lg overflow-hidden flex flex-col md:flex-row transition-shadow hover:shadow-xl">
              <img src="Gemini_Generated_Image_7br6ua7br6ua7br6.png" alt="Phòng Đơn" class="w-full md:w-1/3 h-60 md:h-auto object-cover">
              <div class="p-6 flex flex-col justify-between w-full">
                <div>
                  <h3 class="text-2xl font-semibold mb-2 text-blue-700">Phòng Đơn Tiêu Chuẩn</h3>
                  <p class="text-gray-600 mb-4">Gọn gàng và tiện lợi cho khách du lịch một mình. Giường đơn, 20m², bàn làm việc, miễn phí buffet sáng.</p>
                </div>
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mt-4">
                  <span class="text-2xl font-bold text-gray-900 mb-3 md:mb-0">1.200.000 VNĐ<span class="text-sm font-normal text-gray-600"> / đêm</span></span>
                  <button 
                    class="btn-select-room bg-blue-600 text-white py-2 px-5 rounded-xl font-semibold hover:bg-blue-700 transition-colors"
                    data-room-id="P005"
                    data-room-name="Phòng Đơn Tiêu Chuẩn"
                    data-room-price="1200000">
                    Chọn phòng này
                  </button>
                </div>
              </div>
            </div>

          </div>

          <!-- CỘT PHẢI: FORM ĐẶT PHÒNG (STICKY) -->
          <div class="lg:col-span-1">
            <div class="bg-white rounded-2xl shadow-lg p-6 lg:sticky lg:top-28">
              <h3 class="text-2xl font-semibold mb-6 text-center">Thông tin Đặt phòng</h3>
              <form id="bookingForm" class="space-y-4">
                
                <!-- Thông tin phòng đã chọn -->
                <div>
                  <label class="block text-sm font-medium mb-1">Phòng đã chọn</label>
                  <div class
="w-full bg-gray-100 rounded-xl px-3 py-3 text-gray-700 font-semibold min-h-[40px]">
                    <span id="selectedRoomName">Chưa chọn phòng</span>
                  </div>
                  <input type="hidden" id="selectedRoomId" value="">
                  <input type="hidden" id="selectedRoomPrice" value="0">
                </div>

                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label class="block text-sm font-medium mb-1" for="checkin">Ngày nhận phòng</label>
                    <input type="date" id="checkin" required class="w-full border rounded-xl px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none">
                  </div>
                  <div>
                    <label class="block text-sm font-medium mb-1" for="checkout">Ngày trả phòng</label>
                    <input type="date" id="checkout" required class="w-full border rounded-xl px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none">
                  </div>
                </div>

                <div>
                  <label class="block text-sm font-medium mb-1" for="guests">Số lượng khách</label>
                  <input type="number" id="guests" min="1" value="1" required class="w-full border rounded-xl px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none">
                </div>
                
                <hr class="my-4">

                <!-- Thông tin người đặt -->
                <h4 class="text-lg font-semibold text-gray-800">Thông tin người đặt</h4>
                  <div>
    <label class="block text-sm font-medium mb-1" for="bookingName">Họ và Tên</label>
    <input type="text" id="bookingName" required 
           class="w-full border rounded-xl px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none 
                  bg-gray-100 text-gray-700 font-semibold" 
           readonly>
</div>

<div>
    <label class="block text-sm font-medium mb-1" for="bookingSdt">Số điện thoại</label>
    <input type="text" id="bookingSdt" required 
           class="w-full border rounded-xl px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none 
                  bg-gray-100 text-gray-700 font-semibold" 
           readonly>
</div>

<div>
    <label class="block text-sm font-medium mb-1" for="bookingEmail">Email</label>
    <input type="text" id="bookingEmail" required 
           class="w-full border rounded-xl px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none 
                  bg-gray-100 text-gray-700 font-semibold" 
           readonly>
</div>
                <div>
                  <label class="block text-sm font-medium mb-1" for="bookingCccd">Số CCCD</label>
                  <input type="text" id="bookingCccd" placeholder="Nhập số Căn cước công dân" required class="w-full border rounded-xl px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none">
                </div>
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label class="block text-sm font-medium mb-1" for="bookingDob">Năm sinh</label>
                    <input type="number" id="bookingDob" placeholder="VD: 1990" required class="w-full border rounded-xl px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none">
                  </div>
                  <div>
                    <label class="block text-sm font-medium mb-1" for="bookingHometown">Địa chỉ thường trú</label>
                    <input type="text" id="bookingHometown" placeholder="VD:số 2XX đường xx/ quận xx/ Hà Nội" required class="w-full border rounded-xl px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none">
                  </div>
                </div>
                <!-- KẾT THÚC THÊM TRƯỜNG MỚI -->


                <!-- Tổng chi phí -->
                <div class="pt-4 text-center">
                  <span class="text-sm text-gray-600">Tổng chi phí (tạm tính)</span>
                  <p id="totalPrice" class="text-3xl font-bold text-blue-700">0 VNĐ</p>
                </div>

                <p id="bookingMessage" class="text-sm text-center text-red-600 min-h-[1.25rem]"></p>
                
                <button type="submit" class="w-full bg-green-600 text-white py-3 rounded-xl font-bold text-lg hover:bg-green-700 transition-colors">
                  Xác nhận Đặt phòng
                </button>
              </form>
            </div>
          </div>

        </div>
      </div>
    </section>
  </main>

  <!-- MODAL THÔNG BÁO (Copy từ trang chủ) -->
  <div id="messageModal" class="fixed inset-0 bg-black bg-opacity-50 hidden justify-center items-center z-50 p-4">
    <div class="bg-white text-gray-800 w-full max-w-md rounded-2xl shadow-xl p-6 relative text-center">
        <h3 id="messageTitle" class="text-xl font-bold mb-4">Thông báo</h3>
        <p id="messageText" class="mb-4"></p>
        <button onclick="closeMessageModal()" class="bg-blue-600 text-white px-6 py-2 rounded-xl hover:bg-blue-700 transition-colors">OK</button>
    </div>
  </div>


  <script>
    // ----- HÀM MODAL THÔNG BÁO -----
    const messageModal = document.getElementById("messageModal");
    function closeMessageModal() {
        messageModal.classList.add("hidden");
        messageModal.classList.remove("flex");
    }
    function showMessage(title, text) {
        document.getElementById('messageTitle').textContent = title;
        document.getElementById('messageText').textContent = text;
        messageModal.classList.remove("hidden");
        messageModal.classList.add("flex");
    }

    // ----- BIẾN TOÀN CỤC -----
    const welcomeMessage = document.getElementById('welcomeMessage');
    const btnLogout = document.getElementById('btnLogout');
    const bookingNameInput = document.getElementById('bookingName');
    const bookingSdtInput = document.getElementById('bookingSdt');
    const bookingEmailInput = document.getElementById('bookingEmail'); // SỬA: Thêm biến
    const selectedRoomNameEl = document.getElementById('selectedRoomName');
    const selectedRoomIdInput = document.getElementById('selectedRoomId');
    const selectedRoomPriceInput = document.getElementById('selectedRoomPrice');
    const checkinInput = document.getElementById('checkin');
    const checkoutInput = document.getElementById('checkout');
    const totalPriceEl = document.getElementById('totalPrice');
    const bookingForm = document.getElementById('bookingForm');
    const bookingMessage = document.getElementById('bookingMessage');
    let currentUser = null; // Lưu thông tin người dùng

    // ----- KHỞI CHẠY KHI TẢI TRANG -----
    document.addEventListener('DOMContentLoaded', () => {;
      // 1. Kiểm tra đăng nhập
      currentUser = JSON.parse(localStorage.getItem('currentUser'));
      
      if (!currentUser) {
        // Nếu chưa đăng nhập, đá về trang chủ
        alert("Bạn cần đăng nhập để truy cập trang này."); // Dùng alert ở đây chấp nhận được vì đang chuyển trang
        window.location.href = './Trangchu.html';
        return; // Dừng thực thi script
      }
      
      // 2. Nếu đã đăng nhập, điền thông tin
      welcomeMessage.textContent = `Chào, ${currentUser.hoTen}`;
      bookingNameInput.value = currentUser.hoTen;
      bookingSdtInput.value = currentUser.sdt;
      bookingEmailInput.value = currentUser.email || ''; // SỬA: Tự động điền email

      // 3. Set ngày check-in/check-out mặc định
      const today = new Date().toISOString().split('T')[0];
      const tomorrow = new Date(Date.now() + 86400000).toISOString().split('T')[0];
      checkinInput.value = today;
      checkinInput.min = today; // Không cho chọn ngày quá khứ
      checkoutInput.value = tomorrow;
      checkoutInput.min = tomorrow;
      
      // Cập nhật min cho checkout khi checkin thay đổi
      checkinInput.addEventListener('change', () => {
        const checkinDate = new Date(checkinInput.value);
        const nextDay = new Date(checkinDate.getTime() + 86400000).toISOString().split('T')[0];
        checkoutInput.min = nextDay;
        // Nếu ngày checkout < ngày checkin + 1, tự động cập nhật checkout
        if (checkoutInput.value < nextDay) {
          checkoutInput.value = nextDay;
        }
        updateTotalPrice();
      });

      checkoutInput.addEventListener('change', updateTotalPrice);
    });

    // ----- XỬ LÝ ĐĂNG XUẤT -----
    btnLogout.addEventListener('click', () => {
      localStorage.removeItem('currentUser');
      window.location.href = './Trangchu.html';
    });

    // ----- XỬ LÝ CHỌN PHÒNG -----
    document.querySelectorAll('.btn-select-room').forEach(button => {
      button.addEventListener('click', () => {
        // Lấy thông tin từ data-*
        const roomId = button.dataset.roomId;
        const roomName = button.dataset.roomName;
        const roomPrice = button.dataset.roomPrice;

        // Cập nhật form
        selectedRoomNameEl.textContent = roomName;
        selectedRoomIdInput.value = roomId;
        selectedRoomPriceInput.value = roomPrice;

        // Cập nhật giá
        updateTotalPrice();

        // Cuộn đến form đặt phòng trên di động
        if (window.innerWidth < 1024) {
          bookingForm.scrollIntoView({ behavior: 'smooth' });
        }
      });
    });

    // ----- HÀM TÍNH TỔNG GIÁ -----
    function updateTotalPrice() {
      const pricePerNight = parseInt(selectedRoomPriceInput.value) || 0;
      if (pricePerNight === 0) {
        totalPriceEl.textContent = "0 VNĐ";
        return;
      }
      
      const checkinDate = new Date(checkinInput.value);
      const checkoutDate = new Date(checkoutInput.value);

      if (checkoutDate <= checkinDate) {
        totalPriceEl.textContent = "0 VNĐ";
        return; // Ngày trả phòng phải sau ngày nhận
      }

      // Tính số đêm
      const timeDiff = checkoutDate.getTime() - checkinDate.getTime();
      const nightCount = Math.ceil(timeDiff / (1000 * 3600 * 24));

      const total = pricePerNight * nightCount;

      // Format tiền
      totalPriceEl.textContent = `${total.toLocaleString('vi-VN')} VNĐ`;
    }

    // ----- XỬ LÝ SUBMIT FORM ĐẶT PHÒNG -----
    bookingForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      bookingMessage.textContent = "";

      // 1. Lấy dữ liệu
      const roomId = selectedRoomIdInput.value;
      const roomName = selectedRoomNameEl.textContent;
      const checkin = checkinInput.value;
      const checkout = checkoutInput.value;
      const guests = document.getElementById('guests').value;
      const totalPrice = totalPriceEl.textContent;
      const userId = currentUser.id; // Lấy ID từ đối tượng currentUser
      
      // SỬA: Lấy thêm dữ liệu từ các trường mới
      const email = bookingEmailInput.value;
      const cccd = document.getElementById('bookingCccd').value;
      const dob = document.getElementById('bookingDob').value;
      const hometown = document.getElementById('bookingHometown').value;


      // 2. Validate
      if (!roomId) {
        bookingMessage.textContent = "Vui lòng chọn một phòng.";
        return;
      }
      if (new Date(checkout) <= new Date(checkin)) {
        bookingMessage.textContent = "Ngày trả phòng phải sau ngày nhận phòng.";
        return;
      }
      
      // SỬA: Validate các trường mới
      if (!cccd || !dob || !hometown) {
        bookingMessage.textContent = "Vui lòng nhập đủ CCCD, Năm sinh và Quê quán.";
        return;
      }

      // 3. Gửi API
      const submitButton = e.target.querySelector('button[type="submit"]');
      submitButton.disabled = true;
      submitButton.textContent = "Đang xử lý...";

      try {
        const res = await fetch("http://localhost:3000/dat-phong", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            userId,
            roomId,
            roomName: roomName,
            checkin,
            checkout,
            guests,
            totalPrice,
            email, // SỬA: Gửi thêm
            cccd,  // SỬA: Gửi thêm
            dob,   // SỬA: Gửi thêm
            hometown // SỬA: Gửi thêm
          }),
        });

        const data = await res.json();

        if (res.ok) {
          // Đặt phòng thành công
          showMessage("Đặt phòng Thành công", `Bạn đã đặt ${selectedRoomNameEl.textContent} thành công. Cảm ơn bạn!`);
          // Reset form (tùy chọn)
          selectedRoomNameEl.textContent = "Chưa chọn phòng";
          selectedRoomIdInput.value = "";
          selectedRoomPriceInput.value = "0";
          document.getElementById('bookingCccd').value = ""; // SỬA: Reset
          document.getElementById('bookingDob').value = "";   // SỬA: Reset
          document.getElementById('bookingHometown').value = ""; // SỬA: Reset
          updateTotalPrice();
        } else {
          // Lỗi từ server
          bookingMessage.textContent = data.message || "Không thể đặt phòng. Vui lòng thử lại.";
        }
      } catch (err) {
        bookingMessage.textContent = "Không thể kết nối máy chủ.";
      } finally {
        submitButton.disabled = false;
        submitButton.textContent = "Xác nhận Đặt phòng";
      }
    });

  </script>
</body>
</html>

