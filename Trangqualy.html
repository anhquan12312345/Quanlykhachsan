<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá th·ªëng Qu·∫£n l√Ω Kh√°ch s·∫°n Nh√≥m 11</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .sidebar-active { background-color: #1e40af; border-right: 4px solid #60a5fa; }
        .btn { padding: 0.375rem 0.75rem; border-radius: 0.25rem; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .btn-primary { background-color: #0d6efd; color: white; border: 1px solid #0d6efd; }
        .btn-outline-primary { background-color: transparent; color: #0d6efd; border: 1px solid #0d6efd; }
        .btn-primary:hover { background-color: #0b5ed7; }
        .btn-outline-primary:hover { background-color: #0d6efd; color: white; }
        .badge { padding: 0.35em 0.65em; font-size: 0.75em; font-weight: 700; border-radius: 0.25rem; color: white; }
        .bg-success { background-color: #198754; }
        .bg-warning { background-color: #ffc107; color: #000; }
        .bg-secondary { background-color: #6c757d; }
        .bg-primary { background-color: #0d6efd; }
        .text-danger { color: #dc3545; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 h-screen overflow-hidden flex">

    <aside class="w-64 bg-blue-900 text-white flex-shrink-0 flex flex-col transition-all duration-300">
        <div class="p-6 flex items-center justify-center border-b border-blue-800">
            <h1 class="text-2xl font-bold tracking-wider">ADMIN N11</h1>
        </div>

        <nav class="flex-1 overflow-y-auto py-4 space-y-1">
            <button onclick="showSection('dashboard')" class="nav-item w-full flex items-center px-6 py-3 hover:bg-blue-800 transition sidebar-active" id="nav-dashboard">
                <i class="fas fa-chart-line w-5 h-5 mr-3"></i> T·ªïng quan
            </button>
            <button onclick="showSection('rooms')" class="nav-item w-full flex items-center px-6 py-3 hover:bg-blue-800 transition" id="nav-rooms">
                <i class="fas fa-door-open w-5 h-5 mr-3"></i> Ph√≤ng
            </button>
            <button onclick="showSection('payment')" class="nav-item w-full flex items-center px-6 py-3 hover:bg-blue-800 transition" id="nav-payment">
                <i class="fas fa-credit-card w-5 h-5 mr-3"></i> Thanh to√°n
</button>
            <button onclick="showSection('staff')" class="nav-item w-full flex items-center px-6 py-3 hover:bg-blue-800 transition" id="nav-staff">
                <i class="fas fa-users-cog w-5 h-5 mr-3"></i> Nh√¢n l·ª±c
            </button>
            <button onclick="showSection('customers')" class="nav-item w-full flex items-center px-6 py-3 hover:bg-blue-800 transition" id="nav-customers">
                <i class="fas fa-user-tag w-5 h-5 mr-3"></i> Kh√°ch h√†ng
            </button>
            <button onclick="showSection('services')" class="nav-item w-full flex items-center px-6 py-3 hover:bg-blue-800 transition" id="nav-services">
                <i class="fas fa-concierge-bell w-5 h-5 mr-3"></i> D·ªãch v·ª•
            </button>
            <button onclick="showSection('revenue')" class="nav-item w-full flex items-center px-6 py-3 hover:bg-blue-800 transition" id="nav-revenue">
                <i class="fas fa-hand-holding-usd w-5 h-5 mr-3"></i> Th·ªëng k√™ Doanh thu
            </button>
        </nav>

        <div class="p-4 border-t border-blue-800">
            <button onclick="logout()" class="flex items-center text-red-300 hover:text-red-100 w-full">
                <i class="fas fa-sign-out-alt w-5 h-5 mr-3"></i> ƒêƒÉng xu·∫•t
            </button>
        </div>
    </aside>

    <main class="flex-1 flex flex-col h-screen overflow-hidden">
        <header class="bg-white shadow-sm py-4 px-6 flex justify-between items-center z-10">
            <h2 id="page-title" class="text-xl font-bold text-gray-800">T·ªïng quan h·ªá th·ªëng</h2>
            <div class="flex items-center space-x-4">
                <span class="text-sm text-gray-600">Xin ch√†o, <span class="font-bold text-blue-700">Qu·∫£n l√Ω</span></span>
                <div class="h-10 w-10 bg-gray-300 rounded-full overflow-hidden">
                    <img src="/images/traidep.jpg" alt="Admin Avatar">
                </div>
            </div>
        </header>

        <div class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-5 p-6 relative">
            
            <section id="dashboard" class="page-section">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-blue-600">
                        <p class="text-gray-500 text-sm">Doanh thu h√¥m nay</p>
                        <h3 id="stat-revenue" class="text-2xl font-bold text-gray-800">Loading...</h3>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-red-500">
                        <p class="text-gray-500 text-sm">Ph√≤ng ƒëang c√≥ kh√°ch</p>
                        <h3 id="stat-booked" class="text-2xl font-bold text-red-600">...</h3>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-green-500">
<p class="text-gray-500 text-sm">Ph√≤ng tr·ªëng</p>
                        <h3 id="stat-free" class="text-2xl font-bold text-green-600">...</h3>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-yellow-500">
                        <p class="text-gray-500 text-sm">Y√™u c·∫ßu d·ªãch v·ª•</p>
                        <h3 id="stat-services" class="text-2xl font-bold text-gray-800">Loading...</h3>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="font-bold text-xl text-gray-800 flex items-center">
                            <i class="fas fa-chart-bar mr-2 text-blue-600"></i> Bi·ªÉu ƒë·ªì doanh thu theo Tu·∫ßn
                        </h3>
                        <div class="text-sm text-gray-500 bg-gray-100 px-3 py-1 rounded-full">
                            Th√°ng 12/2025
                        </div>
                    </div>
                    <div class="relative h-80 w-full">
                        <canvas id="weeklyRevenueChart"></canvas>
                    </div>
                </div>
            </section>

            <section id="rooms" class="page-section hidden">
                <div class="flex justify-between items-center mb-6 sticky top-0 bg-gray-50 py-3 z-20 border-b">
                    <h3 class="text-lg font-bold text-gray-800">S∆° ƒë·ªì ph√≤ng theo h·∫°ng</h3>
                    <div class="space-x-2 text-sm font-medium flex overflow-x-auto pb-2" id="room-filter-buttons">
                        <button onclick="filterRooms('all')" class="filter-btn px-3 py-1 rounded-full bg-gray-800 text-white shadow-sm transition hover:scale-105 active:scale-95">T·∫•t c·∫£</button>
                        <button onclick="filterRooms('Tr·ªëng')" class="filter-btn px-3 py-1 rounded-full bg-white border border-gray-300 text-gray-700 shadow-sm transition hover:bg-green-50 hover:border-green-500">
                            <span class="w-2 h-2 bg-green-500 rounded-full mr-2 inline-block"></span>Tr·ªëng
                        </button>
                        <button onclick="filterRooms('ƒêang ·ªü')" class="filter-btn px-3 py-1 rounded-full bg-white border border-gray-300 text-gray-700 shadow-sm transition hover:bg-red-50 hover:border-red-500">
                            <span class="w-2 h-2 bg-red-500 rounded-full mr-2 inline-block"></span>ƒêang ·ªü
                        </button>
                        <button onclick="filterRooms('ƒê√£ ƒë·∫∑t')" class="filter-btn px-3 py-1 rounded-full bg-white border border-gray-300 text-gray-700 shadow-sm transition hover:bg-blue-50 hover:border-blue-500">
                            <span class="w-2 h-2 bg-blue-500 rounded-full mr-2 inline-block"></span>ƒê√£ ƒë·∫∑t
                        </button>
<button onclick="filterRooms('B·∫£o tr√¨')" class="filter-btn px-3 py-1 rounded-full bg-white border border-gray-300 text-gray-700 shadow-sm transition hover:bg-gray-100 hover:border-gray-500">
                            <span class="w-2 h-2 bg-gray-500 rounded-full mr-2 inline-block"></span>B·∫£o tr√¨
                        </button>
                    </div>
                </div>
                <div id="rooms-container" class="space-y-8 pb-10"></div>
            </section>

            <section id="payment" class="page-section hidden">
                <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <div class="p-4 border-b flex flex-col bg-gray-50">
                        <div class="flex justify-between items-center mb-3">
                            <div>
                                <button onclick="switchPaymentTab('unpaid')" class="btn btn-primary" id="btnChuaThanhToan">Ch∆∞a thanh to√°n</button>
                                <button onclick="switchPaymentTab('paid')" class="btn btn-outline-primary" id="btnDaThanhToan">ƒê√£ thanh to√°n</button>
                            </div>
                            <div>
                                <input type="text" class="border p-2 rounded w-64" id="searchInput" placeholder="T√¨m t√™n kh√°ch h√†ng..." onkeyup="renderTable()">
                            </div>
                        </div>
                        <table class="w-full text-left border-collapse table-auto">
                            <thead class="bg-gray-100 text-gray-600 text-sm">
                                <tr>
                                    <th class="p-3">M√£ Hƒê</th>
                                    <th class="p-3">Kh√°ch h√†ng</th>
                                    <th class="p-3">Ph√≤ng</th>
                                    <th class="p-3">T·ªïng ti·ªÅn</th>
                                    <th class="p-3">Ng√†y t·∫°o</th>
                                    <th class="p-3">Tr·∫°ng th√°i</th>
                                    <th class="p-3">Thao t√°c</th>
                                </tr>
                            </thead>
                            <tbody id="paymentTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="staff" class="page-section hidden">
                 <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <div class="p-4 border-b flex justify-between items-center">
                        <h3 class="font-bold text-lg">Qu·∫£n l√Ω nh√¢n s·ª±</h3>
                        <button onclick="openSecurityModal('add_nv', null)" class="bg-blue-600 text-white px-4 py-2 rounded shadow hover:bg-blue-700 font-bold transition">
                            + Th√™m NV
                        </button>
                    </div>
                    <table class="w-full text-left border-collapse">
<thead class="bg-gray-100 text-gray-600 text-sm">
                            <tr>
                                <th class="p-3">ID</th>
                                <th class="p-3">H·ªç t√™n</th>
                                <th class="p-3">T√†i kho·∫£n</th>
                                <th class="p-3">M·∫≠t kh·∫©u</th>
                                <th class="p-3">Ch·ª©c v·ª•</th>
                                <th class="p-3">SƒêT</th>
                                <th class="p-3">Email</th>
                                <th class="p-3">Qu√™ qu√°n</th>
                                <th class="p-3">H√†nh ƒë·ªông</th>
                            </tr>
                        </thead>
                        <tbody id="staff-list" class="text-sm"></tbody>
                    </table>
                </div>
            </section>

            <section id="customers" class="page-section hidden">
                <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <div class="p-4 border-b flex justify-between items-center">
                        <h3 class="font-bold">D·ªØ li·ªáu kh√°ch h√†ng</h3>
                        <input type="text" id="searchCustomerInput" onkeyup="filterCustomers()" 
                               placeholder="T√¨m theo T√™n/SƒêT/CCCD..." 
                               class="border rounded px-3 py-1 text-sm w-64 outline-none focus:border-blue-500 transition">
                    </div>
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-gray-100 text-gray-600 text-sm">
                            <tr>
                                <th class="p-3">H·ªç t√™n</th>
                                <th class="p-3">SƒêT</th>
                                <th class="p-3">CCCD</th>
                                <th class="p-3">ƒê√£ s·ª≠ d·ª•ng</th> 
                                <th class="p-3">Chi ti√™u</th>
                            </tr>
                        </thead>
                        <tbody class="text-sm">
                        </tbody>
                    </table>
                </div>
            </section>

            <section id="services" class="page-section hidden">
                <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <div class="p-4 border-b flex justify-between items-center bg-gray-50">
                        <h3 class="font-bold text-lg text-blue-800">Qu·∫£n l√Ω ƒê·∫∑t D·ªãch V·ª•</h3>
                        <div class="flex space-x-2">
                            <button id="btnServiceUnpaid" onclick="switchServiceTab('unpaid')" 
                                    class="px-4 py-2 bg-blue-600 text-white rounded font-bold text-sm shadow hover:bg-blue-700 transition">
                                Ch∆∞a thanh to√°n
                            </button>
                            <button id="btnServicePaid" onclick="switchServiceTab('paid')"
class="px-4 py-2 bg-white text-blue-600 border border-blue-600 rounded font-bold text-sm hover:bg-blue-50 transition">
                                ƒê√£ thanh to√°n
                            </button>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                            <thead class="bg-gray-100 text-gray-600 text-sm uppercase">
                                <tr>
                                    <th class="p-4 border-b">Ng√†y ƒë·∫∑t</th>
                                    <th class="p-4 border-b">Kh√°ch h√†ng</th>
                                    <th class="p-4 border-b">SƒêT</th>
                                    <th class="p-4 border-b">D·ªãch v·ª•</th>
                                    <th class="p-4 border-b text-center">SL</th>
                                    <th class="p-4 border-b text-right">T·ªïng ti·ªÅn</th>
                                    <th class="p-4 border-b">Ng√†y d√πng</th>
                                    <th class="p-4 border-b">Tr·∫°ng th√°i</th>
                                </tr>
                            </thead>
                            <tbody id="services-table-body" class="text-sm text-gray-700"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="revenue" class="page-section hidden">
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-lg">B√°o c√°o doanh thu th√°ng n√†y</h3>
                        <button onclick="loadRevenueReport()" class="text-blue-600 hover:underline text-sm"><i class="fas fa-sync-alt"></i> C·∫≠p nh·∫≠t</button>
                    </div>
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-gray-100 text-gray-700 text-sm uppercase">
                            <tr>
                                <th class="p-3 border-b">Th√°ng</th>
                                <th class="p-3 border-b text-blue-700">D·ªãch v·ª•</th>
                                <th class="p-3 border-b text-green-700">Ph√≤ng</th>
                                <th class="p-3 border-b text-red-700 font-bold text-right">T·ªïng ti·ªÅn</th>
                            </tr>
                        </thead>
                        <tbody id="revenue-table-body" class="text-gray-700 font-medium">
                            <tr><td colspan="4" class="p-4 text-center">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>
        </div>
    </main>

    <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden justify-center items-center z-50">
<div class="bg-white w-full max-w-lg rounded-xl shadow-2xl p-6 relative">
            <h2 class="text-2xl font-bold mb-4">C√†i ƒë·∫∑t</h2>
            <p>Ch·ª©c nƒÉng ƒëang c·∫≠p nh·∫≠t...</p>
            <div class="mt-8 flex justify-end"><button onclick="closeSettings()" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">ƒê√≥ng</button></div>
        </div>
    </div>

    <div id="security-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden justify-center items-center z-[9999]">
        <div class="bg-white w-full max-w-sm rounded-2xl shadow-2xl p-6 relative">
            <button onclick="closeSecurityModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">‚úï</button>
            <div class="text-center mb-6">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4 font-bold text-red-600 text-2xl">üîí</div>
                <h3 class="text-lg font-bold">X√°c th·ª±c quy·ªÅn Admin</h3>
                <p class="text-sm text-gray-500">Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u ƒë·ªÉ th·ª±c hi·ªán.</p>
            </div>
            <div class="space-y-4 text-center">
                <input type="password" id="securityPassInput" placeholder="M·∫≠t kh·∫©u..." class="w-full border-2 border-gray-300 rounded-xl px-4 py-2 text-center text-lg focus:border-blue-500 outline-none">
                <p id="securityError" class="text-red-600 text-sm hidden font-bold italic">‚ö† Sai m·∫≠t kh·∫©u! Th·ª≠ l·∫°i.</p>
                <div class="flex space-x-3">
                    <button onclick="closeSecurityModal()" class="flex-1 bg-gray-200 py-2 rounded-xl font-bold">H·ªßy</button>
                    <button onclick="confirmSecurityAction()" class="flex-1 bg-red-600 text-white py-2 rounded-xl font-bold shadow-lg">X√°c nh·∫≠n</button>
                </div>
            </div>
        </div>
    </div>

    <div id="room-detail-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden justify-center items-center z-50 p-4 transition-opacity">
        <div class="bg-white w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden transform transition-all scale-100">
            <div class="bg-blue-600 p-4 flex justify-between items-center text-white">
                <h3 class="text-xl font-bold flex items-center"><i class="fas fa-info-circle mr-2"></i> Chi ti·∫øt ƒë·∫∑t ph√≤ng</h3>
                <button onclick="closeRoomDetail()" class="hover:bg-blue-700 p-2 rounded-full transition">‚úï</button>
            </div>
            <div class="p-6 space-y-4">
                <div class="text-center border-b pb-4">
                    <h2 id="modal-room-name" class="text-2xl font-bold text-gray-800">Ph√≤ng ???</h2>
                    <span id="modal-status" class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-sm font-bold mt-2 inline-block">ƒêang t·∫£i...</span>
                </div>
                <div class="grid grid-cols-2 gap-4 text-sm">
<div><p class="text-gray-500">H·ªç v√† t√™n</p><p id="modal-guest-name" class="font-bold text-lg text-gray-800">...</p></div>
                    <div><p class="text-gray-500">NƒÉm sinh</p><p id="modal-guest-age" class="font-bold text-gray-800">...</p></div>
                    <div><p class="text-gray-500">CCCD / CMND</p><p id="modal-guest-cccd" class="font-bold text-gray-800">...</p></div>
                    <div><p class="text-gray-500">S·ªë ƒëi·ªán tho·∫°i / Email</p><p id="modal-guest-contact" class="font-bold text-gray-800 truncate">...</p></div>
                </div>
                <hr class="border-gray-100">
                <div class="grid grid-cols-2 gap-4 text-sm bg-gray-50 p-3 rounded-lg">
                    <div><p class="text-gray-500">Check-in</p><p id="modal-checkin" class="font-bold text-blue-600">...</p></div>
                    <div><p class="text-gray-500">Check-out</p><p id="modal-checkout" class="font-bold text-red-600">...</p></div>
                    <div><p class="text-gray-500">S·ªë l∆∞·ª£ng</p><p id="modal-guests" class="font-bold text-gray-800">...</p></div>
                    <div><p class="text-gray-500">T·∫°m t√≠nh</p><p id="modal-price" class="font-bold text-green-600 text-lg">...</p></div>
                </div>
            </div>
            <div class="bg-gray-100 p-4 flex justify-between items-center"><div id="modal-actions" class="flex space-x-3"></div></div>
        </div>
    </div>

    <div id="add-staff-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden justify-center items-center z-[9999] p-4">
        <div class="bg-white w-full max-w-2xl rounded-2xl shadow-2xl overflow-hidden transform transition-all max-h-[90vh] overflow-y-auto">
            <div class="bg-gradient-to-r from-blue-600 to-blue-800 p-6 flex justify-between items-center text-white sticky top-0 z-10">
                <h3 class="text-2xl font-bold flex items-center"><i class="fas fa-user-plus mr-3"></i>Th√™m Nh√¢n Vi√™n M·ªõi</h3>
                <button onclick="closeAddStaffModal()" class="hover:bg-blue-700 p-2 rounded-full transition text-2xl">‚úï</button>
            </div>
            <form id="addStaffForm" class="p-6 space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="md:col-span-2">
                        <label class="block text-sm font-bold mb-2 text-gray-700">H·ªç v√† t√™n <span class="text-red-500">*</span></label>
                        <input type="text" id="staffName" required class="w-full border-2 border-gray-300 rounded-xl px-4 py-2 focus:border-blue-500 outline-none transition" placeholder="Nguy·ªÖn VƒÉn A">
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-2 text-gray-700">T√™n ƒëƒÉng nh·∫≠p <span class="text-red-500">*</span></label>
<input type="text" id="staffUsername" required class="w-full border-2 border-gray-300 rounded-xl px-4 py-2 focus:border-blue-500 outline-none transition" placeholder="nguyenvana">
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-2 text-gray-700">M·∫≠t kh·∫©u <span class="text-red-500">*</span></label>
                        <div class="relative">
                            <input type="password" id="staffPassword" required class="w-full border-2 border-gray-300 rounded-xl px-4 py-2 pr-10 focus:border-blue-500 outline-none transition" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                            <button type="button" onclick="togglePasswordVisibility('staffPassword')" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600"><i class="fas fa-eye" id="icon-staffPassword"></i></button>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-2 text-gray-700">Ch·ª©c v·ª• <span class="text-red-500">*</span></label>
                        <select id="staffRole" required class="w-full border-2 border-gray-300 rounded-xl px-4 py-2 focus:border-blue-500 outline-none transition bg-white">
                            <option value="">-- Ch·ªçn ch·ª©c v·ª• --</option>
                            <option value="Nh√¢n vi√™n">Nh√¢n vi√™n</option>
                            <option value="Qu·∫£n l√Ω">Qu·∫£n l√Ω</option>
                            <option value="L·ªÖ t√¢n">L·ªÖ t√¢n</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-2 text-gray-700">S·ªë ƒëi·ªán tho·∫°i</label>
                        <input type="tel" id="staffPhone" class="w-full border-2 border-gray-300 rounded-xl px-4 py-2 focus:border-blue-500 outline-none transition" placeholder="0912345678" pattern="[0-9]{10,11}">
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-2 text-gray-700">Email</label>
                        <input type="email" id="staffEmail" class="w-full border-2 border-gray-300 rounded-xl px-4 py-2 focus:border-blue-500 outline-none transition" placeholder="nhanvien@khachsan.com">
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-bold mb-2 text-gray-700">Qu√™ qu√°n <span class="text-red-500">*</span></label>
                        <input type="text" id="staffHometown" required class="w-full border-2 border-gray-300 rounded-xl px-4 py-2 focus:border-blue-500 outline-none transition" placeholder="Th√†nh ph·ªë Hu·∫ø, Th·ª´a Thi√™n Hu·∫ø">
                    </div>
                </div>
                <p id="addStaffError" class="text-sm text-red-600 text-center min-h-[1.25rem] font-bold"></p>
<div class="flex space-x-3 pt-4">
                    <button type="button" onclick="closeAddStaffModal()" class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-xl font-bold hover:bg-gray-300 transition"><i class="fas fa-times mr-2"></i>H·ªßy</button>
                    <button type="submit" class="flex-1 bg-gradient-to-r from-blue-600 to-blue-800 text-white py-3 rounded-xl font-bold hover:from-blue-700 hover:to-blue-900 transition shadow-lg"><i class="fas fa-check mr-2"></i>Th√™m Nh√¢n Vi√™n</button>
                </div>
            </form>
        </div>
    </div>

    <div id="edit-staff-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden justify-center items-center z-50 transition-opacity">
        <div class="bg-white w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden transform scale-100">
            <div class="bg-blue-600 p-4 flex justify-between items-center text-white">
                <h3 class="text-xl font-bold"><i class="fas fa-user-edit mr-2"></i> C·∫≠p nh·∫≠t th√¥ng tin</h3>
                <button onclick="closeEditModal()" class="hover:bg-blue-700 p-2 rounded-full transition">‚úï</button>
            </div>
            <div class="p-6 space-y-4">
                <input type="hidden" id="edit-id"> 
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-500 text-sm font-bold mb-1">H·ªç v√† t√™n <span class="text-red-500">*</span></label>
                        <input type="text" id="edit-name" class="w-full border p-2 rounded bg-gray-200 text-gray-500 cursor-not-allowed font-bold" readonly>
                    </div>
                    <div>
                        <label class="block text-gray-500 text-sm font-bold mb-1">T√†i kho·∫£n <span class="text-red-500">*</span></label>
                        <input type="text" id="edit-username" class="w-full border p-2 rounded bg-gray-200 text-gray-500 cursor-not-allowed font-bold" readonly>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-1">M·∫≠t kh·∫©u m·ªõi</label>
                        <input type="text" id="edit-pass" class="w-full border p-2 rounded focus:border-blue-500 focus:ring-1 focus:ring-blue-500" placeholder="Nh·∫≠p n·∫øu mu·ªën ƒë·ªïi...">
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-1">Ch·ª©c v·ª•</label>
                        <select id="edit-role" class="w-full border p-2 rounded focus:border-blue-500">
                            <option value="Nh√¢n vi√™n">Nh√¢n vi√™n</option>
                            <option value="Qu·∫£n l√Ω">Qu·∫£n l√Ω</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
<label class="block text-gray-700 text-sm font-bold mb-1">S·ªë ƒëi·ªán tho·∫°i</label>
                        <input type="text" id="edit-phone" class="w-full border p-2 rounded focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-1">Email</label>
                        <input type="email" id="edit-email" class="w-full border p-2 rounded focus:border-blue-500">
                    </div>
                </div>
            </div>
            <div class="bg-gray-100 p-4 flex justify-end space-x-3">
                <button onclick="closeEditModal()" class="px-4 py-2 bg-gray-300 hover:bg-gray-400 rounded text-gray-800 font-bold transition">H·ªßy</button>
                <button onclick="saveStaffEdit()" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 rounded text-white font-bold shadow transition flex items-center"><i class="fas fa-save mr-2"></i> L∆∞u thay ƒë·ªïi</button>
            </div>
        </div>
    </div>

    <div id="customer-detail-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden justify-center items-center z-[100] p-4">
        <div class="bg-white w-full max-w-5xl rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
            
            <div class="bg-blue-800 p-4 flex justify-between items-center text-white shrink-0">
                <h3 class="text-xl font-bold flex items-center">
                    <i class="fas fa-history mr-2"></i> L·ªãch s·ª≠ kh√°ch h√†ng: <span id="detail-customer-name" class="ml-2 text-yellow-300 uppercase">...</span>
                </h3>
                <button onclick="closeCustomerDetail()" class="hover:bg-blue-700 p-2 rounded-full transition text-xl">‚úï</button>
            </div>

            <div class="p-6 overflow-y-auto flex-1 space-y-8 bg-gray-50">
                
                <div>
                    <h4 class="font-bold text-lg text-gray-800 mb-3 flex items-center">
                        <span class="bg-green-600 w-1 h-6 mr-2 rounded"></span> üè® C√°c ph√≤ng ƒë√£ ƒë·∫∑t
                    </h4>
                    <div class="bg-white rounded-lg shadow border overflow-hidden">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-green-50 text-green-900 font-bold border-b border-green-200">
                                <tr>
                                    <th class="p-3">T√™n ph√≤ng</th>
                                    <th class="p-3">Ng√†y nh·∫≠n (Check-in)</th>
                                    <th class="p-3">Ng√†y tr·∫£ (Check-out)</th>
                                    <th class="p-3 text-right">T·ªïng ti·ªÅn</th>
                                    <th class="p-3 text-center">Tr·∫°ng th√°i</th>
                                </tr>
                            </thead>
                            <tbody id="detail-room-list" class="divide-y divide-gray-100">
</tbody>
                        </table>
                    </div>
                </div>

                <div>
                    <h4 class="font-bold text-lg text-gray-800 mb-3 flex items-center">
                        <span class="bg-blue-600 w-1 h-6 mr-2 rounded"></span> üç∑ D·ªãch v·ª• ƒë√£ s·ª≠ d·ª•ng
                    </h4>
                    <div class="bg-white rounded-lg shadow border overflow-hidden">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-blue-50 text-blue-900 font-bold border-b border-blue-200">
                                <tr>
                                    <th class="p-3">T√™n d·ªãch v·ª•</th>
                                    <th class="p-3 text-center">S·ªë l∆∞·ª£ng</th>
                                    <th class="p-3">Th·ªùi gian ƒë·∫∑t</th>
                                    <th class="p-3 text-right">Th√†nh ti·ªÅn</th>
                                    <th class="p-3 text-center">Tr·∫°ng th√°i</th>
                                </tr>
                            </thead>
                            <tbody id="detail-service-list" class="divide-y divide-gray-100">
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>
            
            <div class="p-4 border-t bg-white flex justify-end shrink-0">
                <button onclick="closeCustomerDetail()" class="px-6 py-2 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold rounded transition">ƒê√≥ng</button>
            </div>
        </div>
    </div>

    <script>
        let pendingAction = null, pendingId = null, allPayments = [], currentTab = 'unpaid', currentServiceTab = 'unpaid', currentRoomFilter = 'all';
        let chartInstance = null; 

        function showSection(sectionId) {
            document.querySelectorAll('.page-section').forEach(sec => sec.classList.add('hidden'));
            document.getElementById(sectionId).classList.remove('hidden');
            if (sectionId === 'rooms') generateRooms();
            if (sectionId === 'staff') loadStaff();
            if (sectionId === 'dashboard') {
                loadDashboardStats();
                drawWeeklyChart(); 
            }
            if (sectionId === 'payment') loadPaymentData();
            if (sectionId === 'services') loadServiceBookings();
            if (sectionId === 'revenue') loadRevenueReport();
            if (sectionId === 'customers') loadCustomers();
            
            const titles = { 'dashboard': 'T·ªïng quan h·ªá th·ªëng', 'rooms': 'S∆° ƒë·ªì ph√≤ng', 'staff': 'Qu·∫£n l√Ω nh√¢n s·ª±', 'payment': 'Thanh to√°n', 'customers': 'Kh√°ch h√†ng', 'services': 'D·ªãch v·ª•', 'revenue': 'Doanh thu' };
            document.getElementById('page-title').textContent = titles[sectionId] || 'Qu·∫£n l√Ω';
            document.querySelectorAll('.nav-item').forEach(btn => btn.classList.remove('sidebar-active'));
document.getElementById('nav-' + sectionId).classList.add('sidebar-active');
        }

        async function loadDashboardStats() {
            try {
                const res = await fetch('http://localhost:3000/api/thong-ke-dashboard');
                if (!res.ok) throw new Error("API ch∆∞a s·∫µn s√†ng");
                const data = await res.json();
                const revenueFormatted = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(data.DoanhThuHomNay || 0);
                document.getElementById('stat-revenue').innerText = revenueFormatted; 
                document.getElementById('stat-booked').innerText = (data.DangO || 0) + ' Ph√≤ng';
                document.getElementById('stat-free').innerText = (data.PhongTrong || 0) + ' Ph√≤ng';
                document.getElementById('stat-services').innerText = (data.DichVuMoi || 0) + ' M·ªõi';
            } catch (error) { 
                console.error(error); 
                document.getElementById('stat-revenue').innerText = '0 ‚Ç´'; 
            }
        }

        async function drawWeeklyChart() {
            const ctx = document.getElementById('weeklyRevenueChart').getContext('2d');
            if (chartInstance) chartInstance.destroy();
            let realData = [0, 0, 0, 0];
            try {
                const res = await fetch('http://localhost:3000/api/bieu-do-tuan');
                if(res.ok) realData = await res.json();
            } catch (e) { console.error("L·ªói t·∫£i bi·ªÉu ƒë·ªì:", e); }

            const labels = ['Tu·∫ßn 1 (1-7)', 'Tu·∫ßn 2 (8-14)', 'Tu·∫ßn 3 (15-21)', 'Tu·∫ßn 4 (22-31)'];
            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Doanh thu (VNƒê)',
                        data: realData,
                        backgroundColor: ['rgba(54, 162, 235, 0.7)', 'rgba(75, 192, 192, 0.7)', 'rgba(255, 205, 86, 0.7)', 'rgba(255, 99, 132, 0.7)'],
                        borderColor: ['rgb(54, 162, 235)', 'rgb(75, 192, 192)', 'rgb(255, 205, 86)', 'rgb(255, 99, 132)'],
                        borderWidth: 1, borderRadius: 5, barThickness: 50
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, ticks: { callback: function(value) { return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND', maximumSignificantDigits: 3 }).format(value); } } } },
                    plugins: { legend: { display: false }, tooltip: { callbacks: { label: function(context) { let label = context.dataset.label || ''; if (label) { label += ': '; } if (context.parsed.y !== null) { label += new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(context.parsed.y); } return label; } } } }
                }
            });
}

        async function loadStaff() {
            const list = document.getElementById('staff-list');
            list.innerHTML = '<tr><td colspan="9" class="p-10 text-center">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>';
            try {
                const res = await fetch('http://localhost:3000/api/nhan-vien');
                const data = await res.json();
                let html = '';
                data.forEach(nv => {
                    const color = nv.ChucVu.toLowerCase() === 'admin' ? 'text-red-600 font-bold' : '';
                    let deleteButton = '';
                    if (nv.MaNV == 1) { deleteButton = `<span class="text-gray-400 italic text-sm cursor-not-allowed">M·∫∑c ƒë·ªãnh</span>`; } 
                    else { deleteButton = `<button onclick="handleDelete('${nv.MaNV}')" class="text-red-600 font-bold hover:underline text-sm">X√≥a</button>`; }
                    html += `<tr class="border-b hover:bg-gray-50 transition"><td class="p-3 font-bold text-blue-700">NV${nv.MaNV}</td><td class="p-3 font-medium">${nv.HoTen}</td><td class="p-3 text-gray-700 font-medium">${nv.TenDangNhap || '---'}</td><td class="p-3"><div class="flex items-center space-x-2 bg-gray-100 px-2 py-1 rounded w-fit border"><span id="pass-txt-${nv.MaNV}" data-realpass="${nv.MatKhau}" class="font-mono text-xs tracking-widest text-gray-600">******</span><i onclick="openSecurityModal('view_pass', '${nv.MaNV}')" class="fas fa-eye cursor-pointer text-blue-400 hover:text-blue-600 text-xs ml-2" title="Xem m·∫≠t kh·∫©u"></i></div></td><td class="p-3 uppercase text-xs ${color}">${nv.ChucVu}</td><td class="p-3">${nv.SoDienThoai || '-'}</td><td class="p-3 text-gray-500 text-xs truncate max-w-[150px]">${nv.Email || '-'}</td><td class="p-3 text-gray-600 text-sm">${nv.QueQuan || '-'}</td><td class="p-3"><button onclick="handleEdit('${nv.MaNV}')" class="text-blue-600 font-bold mr-3 hover:underline text-sm">S·ª≠a</button>${deleteButton}</td></tr>`;
                });
                list.innerHTML = html;
            } catch (e) { list.innerHTML = '<tr><td colspan="9" class="p-5 text-red-500 text-center">L·ªói k·∫øt n·ªëi Server!</td></tr>'; }
        }

        function filterRooms(status) {
            currentRoomFilter = status; generateRooms();
            document.querySelectorAll('.filter-btn').forEach(btn => {
                if(btn.textContent.includes('T·∫•t c·∫£')) btn.className = "filter-btn px-3 py-1 rounded-full border border-gray-300 text-gray-700 shadow-sm transition hover:scale-105";
                else btn.classList.remove('ring-2', 'ring-offset-1', 'ring-blue-500');
                if(status === 'all' && btn.innerText.includes('T·∫•t c·∫£')) btn.className = "filter-btn px-3 py-1 rounded-full bg-gray-800 text-white shadow-sm transition hover:scale-105";
                else if(btn.innerText.includes(status) && status !== 'all') btn.classList.add('ring-2', 'ring-offset-1', 'ring-blue-500');
            });
        }
async function generateRooms() {
            const container = document.getElementById('rooms-container');
            container.innerHTML = '<div class="text-center py-10 text-gray-500"><i class="fas fa-spinner fa-spin text-2xl mb-2"></i><br>ƒêang t·∫£i s∆° ƒë·ªì...</div>';
            try {
                const res = await fetch('http://localhost:3000/api/phong');
                let data = await res.json();
                if (currentRoomFilter !== 'all') data = data.filter(room => room.TrangThai === currentRoomFilter);
                if (!data || data.length === 0) { container.innerHTML = `<div class="text-center text-gray-400 italic py-10">Kh√¥ng t√¨m th·∫•y ph√≤ng "${currentRoomFilter}"<br><button onclick="filterRooms('all')" class="mt-2 text-blue-600 hover:underline">Xem t·∫•t c·∫£</button></div>`; return; }
                const priorityOrder = ['T·ªïng th·ªëng', 'VIP', 'Suite gia ƒë√¨nh', 'Gia ƒë√¨nh', 'Deluxe', 'C·∫∑p ƒë√¥i', 'ƒê∆°n ti√™u chu·∫©n', 'Ti√™u chu·∫©n'];
                const groupedRooms = {};
                data.forEach(room => { const type = room.LoaiPhong || 'Kh√°c'; if (!groupedRooms[type]) groupedRooms[type] = []; groupedRooms[type].push(room); });
                const sortedKeys = Object.keys(groupedRooms).sort((a, b) => { const indexA = priorityOrder.indexOf(a); const indexB = priorityOrder.indexOf(b); return (indexA === -1 ? 999 : indexA) - (indexB === -1 ? 999 : indexB); });
                let fullHtml = '';
                sortedKeys.forEach(type => {
                    const roomsInGroup = groupedRooms[type];
                    let groupIcon = 'fa-bed', titleColor = 'text-gray-700';
                    if (type.includes('T·ªïng th·ªëng')) { groupIcon = 'fa-crown'; titleColor = 'text-yellow-600'; }
                    else if (type.includes('Gia ƒë√¨nh')) { groupIcon = 'fa-users'; titleColor = 'text-purple-600'; }
                    else if (type.includes('Deluxe') || type.includes('VIP')) { groupIcon = 'fa-gem'; titleColor = 'text-blue-600'; }
                    else if (type.includes('C·∫∑p ƒë√¥i')) { groupIcon = 'fa-heart'; titleColor = 'text-pink-500'; }
                    fullHtml += `<div class="room-group"><h4 class="text-xl font-bold mb-3 flex items-center ${titleColor} border-l-4 border-current pl-3"><i class="fas ${groupIcon} mr-2"></i> ${type} <span class="ml-2 text-sm font-normal text-gray-400">(${roomsInGroup.length} ph√≤ng)</span></h4><div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4">`;
                    roomsInGroup.forEach(room => {
                        let statusClass = 'bg-white border border-gray-200', statusText = '<span class="text-green-600 font-bold text-xs"><i class="fas fa-circle text-[8px] mr-1"></i>Tr·ªëng</span>', guestInfo = '';
if (room.TrangThai === 'B·∫£o tr√¨') { statusClass = 'bg-gray-100 border-l-4 border-gray-500 shadow-sm'; statusText = '<span class="text-gray-600 font-bold text-xs"><i class="fas fa-circle text-[8px] mr-1"></i>B·∫£o tr√¨</span>'; guestInfo = '<div class="text-xs text-gray-500 font-medium mt-1 truncate border-t border-gray-200 pt-1"><i class="fas fa-tools mr-1"></i>ƒêang d·ªçn d·∫πp</div>'; }
                        else if (room.TrangThai === 'ƒêang ·ªü') { statusClass = 'bg-red-50 border-l-4 border-red-500 shadow-sm'; statusText = '<span class="text-red-600 font-bold text-xs"><i class="fas fa-circle text-[8px] mr-1"></i>ƒêang ·ªü</span>'; if (room.TenKhachHang) guestInfo = `<div class="text-xs text-red-700 font-semibold mt-1 truncate border-t border-red-200 pt-1"><i class="fas fa-user mr-1"></i>${room.TenKhachHang}</div>`; }
                        else if (room.TrangThai === 'ƒê√£ ƒë·∫∑t') { statusClass = 'bg-blue-50 border-l-4 border-blue-500 shadow-sm'; statusText = '<span class="text-blue-600 font-bold text-xs"><i class="fas fa-circle text-[8px] mr-1"></i>ƒê√£ ƒë·∫∑t</span>'; if (room.TenKhachHang) guestInfo = `<div class="text-xs text-blue-700 font-medium mt-1 truncate border-t border-blue-200 pt-1"><i class="fas fa-user-clock mr-1"></i>${room.TenKhachHang}</div>`; }
                        const giaTien = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(room.GiaPhong);
                        fullHtml += `<div class="relative p-4 rounded-xl shadow-sm hover:shadow-md transition duration-300 flex flex-col justify-between min-h-[140px] group ${statusClass} cursor-pointer"><div><div class="flex justify-between items-start"><h4 class="text-lg font-bold text-gray-800">${room.TenPhong}</h4><div class="text-2xl opacity-10 group-hover:opacity-30 transition"><i class="fas ${groupIcon}"></i></div></div><div class="text-sm font-semibold text-gray-500">${giaTien}</div>${guestInfo}</div><div class="flex items-center justify-between mt-2 pt-2 border-t border-gray-100/50"><div>${statusText}</div><button onclick="openRoomDetail('${room.MaPhong}')" class="text-xs bg-white border border-gray-300 px-2 py-1 rounded hover:bg-blue-600 hover:text-white transition shadow-sm z-10 relative">Chi ti·∫øt</button></div></div>`;
                    });
                    fullHtml += `</div></div><hr class="border-gray-200 my-6">`;
                });
                container.innerHTML = fullHtml;
            } catch (e) { console.error("‚ùå L·ªói:", e); container.innerHTML = '<div class="text-red-500 text-center">L·ªói hi·ªÉn th·ªã d·ªØ li·ªáu!</div>'; }
        }

        async function openRoomDetail(roomCode) {
            const modal = document.getElementById('room-detail-modal');
            const actionDiv = document.getElementById('modal-actions');
            document.getElementById('modal-room-name').innerText = "ƒêang t·∫£i...";
            document.getElementById('modal-status').innerText = "...";
document.getElementById('modal-guest-name').innerText = "...";
            actionDiv.innerHTML = ""; modal.classList.remove('hidden'); modal.classList.add('flex');
            try {
                const resRoom = await fetch(`http://localhost:3000/api/phong`);
                const allRooms = await resRoom.json();
                const currentRoom = allRooms.find(r => r.MaPhong === roomCode);
                if (!currentRoom) { alert("‚ùå Kh√¥ng t√¨m th·∫•y ph√≤ng!"); closeRoomDetail(); return; }
                const trangThai = currentRoom.TrangThai || 'Tr·ªëng';
                document.getElementById('modal-room-name').innerText = currentRoom.TenPhong;
                document.getElementById('modal-status').innerText = trangThai;
                if (trangThai === 'B·∫£o tr√¨') { document.getElementById('modal-status').className = "bg-gray-200 text-gray-700 px-3 py-1 rounded-full text-sm font-bold mt-2 inline-block"; document.getElementById('modal-status').innerText = "ƒêang b·∫£o tr√¨"; document.getElementById('modal-guest-name').innerText = "Ph√≤ng ƒëang d·ªçn d·∫πp"; actionDiv.innerHTML = `<button onclick="handleCleanRoom('${roomCode}')" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-bold shadow-md flex items-center"><i class="fas fa-broom mr-2"></i> D·ªåN PH√íNG XONG</button>`; return; }
                const res = await fetch(`http://localhost:3000/api/dat-phong/chi-tiet/${roomCode}`);
                if (!res.ok) { document.getElementById('modal-status').innerText = "Ph√≤ng Tr·ªëng"; document.getElementById('modal-status').className = "bg-green-100 text-green-700 px-3 py-1 rounded-full text-sm font-bold mt-2 inline-block"; document.getElementById('modal-guest-name').innerText = "Ch∆∞a c√≥ kh√°ch"; return; }
                const data = await res.json();
                document.getElementById('modal-guest-name').innerText = data.HoTen || "Kh√°ch v√£ng lai";
                document.getElementById('modal-guest-cccd').innerText = data.CCCD || "Ch∆∞a c·∫≠p nh·∫≠t";
                document.getElementById('modal-guest-contact').innerText = data.Email || data.SoDienThoai || "Kh√¥ng c√≥";
                let rawDOB = data.NamSinh || data.DOB; let birthYear = 0, currentYear = new Date().getFullYear();
                if (rawDOB) { let strDOB = String(rawDOB); const yearMatch = strDOB.match(/(19|20)\d{2}/); if (yearMatch) birthYear = parseInt(yearMatch[0]); else if (!isNaN(rawDOB)) birthYear = parseInt(rawDOB); }
                if (birthYear > 1900 && birthYear <= currentYear) document.getElementById('modal-guest-age').innerText = `${currentYear - birthYear} tu·ªïi (${birthYear})`; else document.getElementById('modal-guest-age').innerText = `${rawDOB || 'Tr·ªëng'}`;
                const formatDate = (d) => d ? new Date(d).toLocaleDateString('vi-VN') : '...';
                document.getElementById('modal-checkin').innerText = formatDate(data.CheckIn);
document.getElementById('modal-checkout').innerText = formatDate(data.CheckOut);
                document.getElementById('modal-guests').innerText = (data.SoLuongKhach || 0) + " ng∆∞·ªùi";
                let total = data.TongTien || 0; if (typeof total === 'string') total = parseFloat(total.replace(/[^0-9]/g, ''));
                document.getElementById('modal-price').innerText = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(total);
                if (trangThai === 'ƒê√£ ƒë·∫∑t') { document.getElementById('modal-status').className = "bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-sm font-bold mt-2 inline-block"; actionDiv.innerHTML = `<button onclick="handleCheckIn('${roomCode}')" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-bold shadow-md flex items-center"><i class="fas fa-check-circle mr-2"></i> CHECK-IN</button>`; } else if (trangThai === 'ƒêang ·ªü') { document.getElementById('modal-status').className = "bg-red-100 text-red-700 px-3 py-1 rounded-full text-sm font-bold mt-2 inline-block"; actionDiv.innerHTML = `<button onclick="handleCheckout('${roomCode}')" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold shadow-md flex items-center"><i class="fas fa-money-bill-wave mr-2"></i> THANH TO√ÅN</button>`; }
            } catch (e) { console.error("‚ùå L·ªói modal:", e); }
        }

        function closeRoomDetail() { document.getElementById('room-detail-modal').classList.add('hidden'); document.getElementById('room-detail-modal').classList.remove('flex'); }
        async function handleCheckIn(roomCode) { 
    if(!confirm("‚úÖ X√°c nh·∫≠n kh√°ch ƒë√£ ƒë·∫øn v√† Check-in?")) return; 
    
    try { 
        console.log(`üîë [CHECK-IN] ƒêang x·ª≠ l√Ω ph√≤ng: ${roomCode}`);
        
        const res = await fetch(`http://localhost:3000/api/check-in/${roomCode}`, { 
            method: 'PUT' 
        }); 
        
        const data = await res.json(); 
        
        if (data.success) {
            alert("‚úÖ " + data.message); 
            closeRoomDetail(); // ƒê√≥ng modal
            
            // ‚≠ê QUAN TR·ªåNG: L√†m m·ªõi danh s√°ch ph√≤ng
            setTimeout(() => {
                generateRooms(); // T·∫£i l·∫°i s∆° ƒë·ªì ph√≤ng
                loadDashboardStats(); // C·∫≠p nh·∫≠t s·ªë li·ªáu th·ªëng k√™
            }, 500);
        } else {
            alert("‚ö†Ô∏è " + (data.message || "C√≥ l·ªói x·∫£y ra!"));
        }
        
    } catch(e) { 
        console.error("‚ùå L·ªói Check-in:", e);
        alert("‚ùå L·ªói k·∫øt n·ªëi server!"); 
    } 
}
async function handleCheckout(roomCode) { if(!confirm("‚ö†Ô∏è X√°c nh·∫≠n THANH TO√ÅN v√† chuy·ªÉn ph√≤ng sang B·∫¢O TR√å?")) return; try { const res = await fetch(`http://localhost:3000/api/thanh-toan/${roomCode}`, { method: 'PUT' }); const data = await res.json(); if (data.success) { alert("‚úÖ " + data.message); closeRoomDetail(); setTimeout(() => generateRooms(), 300); } else { alert("‚ö†Ô∏è " + data.message); } } catch(e) { alert("‚ùå L·ªói k·∫øt n·ªëi server!"); } }
        async function handleCleanRoom(roomCode) { if(!confirm("‚úÖ X√°c nh·∫≠n ƒë√£ d·ªçn ph√≤ng xong v√† s·∫µn s√†ng ƒë√≥n kh√°ch?")) return; try { const res = await fetch(`http://localhost:3000/api/don-phong/${roomCode}`, { method: 'PUT' }); const data = await res.json(); alert(data.message); closeRoomDetail(); setTimeout(() => generateRooms(), 300); } catch(e) { alert("‚ùå L·ªói k·∫øt n·ªëi!"); } }
        window.handleCleanRoom = handleCleanRoom;

        function openSecurityModal(action, id) { pendingAction = action; pendingId = id; document.getElementById('securityPassInput').value = ''; document.getElementById('securityError').classList.add('hidden'); document.getElementById('security-modal').classList.remove('hidden'); document.getElementById('security-modal').classList.add('flex'); setTimeout(() => document.getElementById('securityPassInput').focus(), 100); }
        function closeSecurityModal() { document.getElementById('security-modal').classList.add('hidden'); document.getElementById('security-modal').classList.remove('flex'); }
        function handleDelete(id) { openSecurityModal('delete', id); }
        function handleEdit(id) { openSecurityModal('edit', id); }

        async function confirmSecurityAction() {
            const pass = document.getElementById('securityPassInput').value;
            if (pass !== "hellomyfen") { document.getElementById('securityError').classList.remove('hidden'); return; }
            closeSecurityModal();
            if (pendingAction === 'delete') {
                if (!confirm("H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c. B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a?")) return;
                try { const res = await fetch(`http://localhost:3000/api/nhan-vien/${pendingId}`, { method: 'DELETE' }); const data = await res.json(); alert(data.message); loadStaff(); } catch (e) { alert("L·ªói khi x√≥a nh√¢n vi√™n!"); }
            } else if (pendingAction === 'view_pass') {
                const spanPass = document.getElementById(`pass-txt-${pendingId}`);
                if(spanPass) { spanPass.innerText = spanPass.getAttribute('data-realpass'); spanPass.classList.remove('tracking-widest', 'text-gray-600'); spanPass.classList.add('text-red-600', 'font-bold'); }
            } else if (pendingAction === 'add_nv') {
                openAddStaffModal();
            } else if (pendingAction === 'edit') {
                openEditStaffForm(pendingId);
            }
        }

        async function openEditStaffForm(staffId) {
            try {
const res = await fetch('http://localhost:3000/api/nhan-vien');
                const allStaff = await res.json();
                const staff = allStaff.find(s => s.MaNV == staffId);
                if (!staff) { alert("Kh√¥ng t√¨m th·∫•y nh√¢n vi√™n!"); return; }
                document.getElementById('edit-id').value = staff.MaNV;
                document.getElementById('edit-name').value = staff.HoTen;
                document.getElementById('edit-username').value = staff.TenDangNhap;
                document.getElementById('edit-pass').value = staff.MatKhau;
                document.getElementById('edit-role').value = staff.ChucVu;
                document.getElementById('edit-phone').value = staff.SoDienThoai;
                document.getElementById('edit-email').value = staff.Email;
                const modal = document.getElementById('edit-staff-modal');
                modal.classList.remove('hidden'); modal.classList.add('flex');
            } catch (e) { console.error(e); alert("L·ªói t·∫£i th√¥ng tin!"); }
        }

        function closeEditModal() { const modal = document.getElementById('edit-staff-modal'); modal.classList.add('hidden'); modal.classList.remove('flex'); }

            async function saveStaffEdit() {
                const id = document.getElementById('edit-id').value;
                const newPass = document.getElementById('edit-pass').value;
                const newRole = document.getElementById('edit-role').value;
                const newPhone = document.getElementById('edit-phone').value;
                const newEmail = document.getElementById('edit-email').value;
                if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën c·∫≠p nh·∫≠t th√¥ng tin nh√¢n vi√™n n√†y?")) return;
                try {
                    const res = await fetch(`http://localhost:3000/api/nhan-vien/${id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ MatKhau: newPass, ChucVu: newRole, SoDienThoai: newPhone, Email: newEmail }) });
                    const data = await res.json();
                    if (data.success || res.ok) { alert("‚úÖ C·∫≠p nh·∫≠t th√†nh c√¥ng!"); closeEditModal(); loadStaff(); } else { alert("‚ùå L·ªói: " + (data.message || "Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t")); }
                } catch (e) { console.error(e); alert("‚ùå L·ªói k·∫øt n·ªëi Server!"); }
        }

        function openSettings() { document.getElementById('settings-modal').classList.remove('hidden'); document.getElementById('settings-modal').classList.add('flex'); }
        function closeSettings() { document.getElementById('settings-modal').classList.add('hidden'); document.getElementById('settings-modal').classList.remove('flex'); }
        function logout() { if(confirm('B·∫°n mu·ªën ƒëƒÉng xu·∫•t?')) window.location.href = 'Trangchu.html'; }
async function loadPaymentData() { try { const response = await fetch('http://localhost:3000/api/quan-ly-thanh-toan'); allPayments = await response.json(); renderTable(); } catch (error) { console.error("L·ªói t·∫£i d·ªØ li·ªáu:", error); } }
        
        function switchPaymentTab(tab) {
            currentTab = tab;
            const btnUnpaid = document.getElementById('btnChuaThanhToan');
            const btnPaid = document.getElementById('btnDaThanhToan');
            if (tab === 'unpaid') {
                btnUnpaid.className = 'btn btn-primary'; btnUnpaid.classList.remove('btn-outline-primary');
                btnPaid.className = 'btn btn-outline-primary'; btnPaid.classList.remove('btn-primary');
            } else {
                btnUnpaid.className = 'btn btn-outline-primary'; btnUnpaid.classList.remove('btn-primary');
                btnPaid.className = 'btn btn-primary'; btnPaid.classList.remove('btn-outline-primary');
            }
            renderTable();
        }

        function renderTable() {
            const tableBody = document.getElementById('paymentTableBody'); 
            const searchInput = document.getElementById('searchInput');
            const searchKeyword = searchInput ? searchInput.value.toLowerCase() : ''; 
            
            tableBody.innerHTML = ''; 
            
            if (!allPayments || allPayments.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" class="text-center p-4">ƒêang t·∫£i ho·∫∑c kh√¥ng c√≥ d·ªØ li·ªáu...</td></tr>';
                return;
            }

            const filteredData = allPayments.filter(item => { 
                let matchTab = (currentTab === 'unpaid') ? (item.TrangThai === 'ƒêang ·ªü') : (item.TrangThai === 'ƒê√£ thanh to√°n');
                const tenKhach = item.TenKhachHang ? item.TenKhachHang.toLowerCase() : '';
                const matchSearch = tenKhach.includes(searchKeyword); 
                return matchTab && matchSearch; 
            });

            if (filteredData.length === 0) { 
                const msg = (currentTab === 'unpaid') ? 'Kh√¥ng c√≥ ph√≤ng n√†o ƒëang ·ªü c·∫ßn thanh to√°n.' : 'Kh√¥ng c√≥ l·ªãch s·ª≠ thanh to√°n n√†o.';
                tableBody.innerHTML = `<tr><td colspan="7" class="text-center p-4 text-gray-500 italic">${msg}</td></tr>`; 
                return; 
            }

            filteredData.forEach(item => { 
                const dateStr = new Date(item.NgayDat).toLocaleDateString('vi-VN'); 
                const moneyStr = new Intl.NumberFormat('vi-VN').format(item.TongTien);

                let badgeClass = 'bg-secondary'; 
                let actionButton = '';

                if (item.TrangThai === 'ƒê√£ thanh to√°n') {
                    badgeClass = 'bg-success';
                    actionButton = `<button class="text-gray-400 border border-gray-300 px-3 py-1 rounded text-sm cursor-not-allowed" disabled>ƒê√£ xong</button>`;
                } else {
badgeClass = (item.TrangThai === 'ƒêang ·ªü') ? 'bg-warning' : 'bg-primary';
                    actionButton = `
                        <button onclick="handleCheckout('${item.RoomCode}')" 
                                class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700 font-bold shadow-sm text-sm transition flex items-center">
                            <i class="fas fa-money-bill-wave mr-1"></i> Thanh to√°n
                        </button>
                    `;
                }

                tableBody.innerHTML += `
                    <tr class="border-b hover:bg-gray-50 transition">
                        <td class="p-3 text-sm text-gray-500">#${item.MaHD}</td>
                        <td class="p-3 font-bold text-gray-800">${item.TenKhachHang || 'Kh√°ch v√£ng lai'}</td>
                        <td class="p-3">${item.TenPhong}</td>
                        <td class="p-3 text-red-600 font-bold text-lg">${moneyStr} ‚Ç´</td>
                        <td class="p-3 text-sm text-gray-600">${dateStr}</td>
                        <td class="p-3"><span class="badge ${badgeClass}">${item.TrangThai}</span></td>
                        <td class="p-3">${actionButton}</td>
                    </tr>
                `; 
            });
        }

        async function loadServiceBookings() {
            const tbody = document.getElementById('services-table-body'); 
            tbody.innerHTML = '<tr><td colspan="8" class="p-4 text-center"><i class="fas fa-spinner fa-spin"></i> ƒêang t·∫£i...</td></tr>';
            try {
                const res = await fetch('http://localhost:3000/api/quan-ly-dich-vu'); 
                const allData = await res.json();
                
                const filteredData = allData.filter(item => { 
                    if (currentServiceTab === 'unpaid') return item.Status !== 'ƒê√£ thanh to√°n' && item.Status !== 'ƒê√£ h·ªßy'; 
                    else return item.Status === 'ƒê√£ thanh to√°n'; 
                });

                if (filteredData.length === 0) { 
                    tbody.innerHTML = '<tr><td colspan="8" class="p-4 text-center text-gray-500">Kh√¥ng c√≥ d·ªØ li·ªáu ph√π h·ª£p.</td></tr>'; 
                    return; 
                }

                let html = '';
                filteredData.forEach(item => {
                    const ngayDat = item.OrderDate ? new Date(item.OrderDate).toLocaleString('vi-VN') : '';
                    const ngayDung = item.ServiceDate ? new Date(item.ServiceDate).toLocaleDateString('vi-VN') : '';
                    
                    // --- PH·∫¶N S·ª¨A L·ªñI QUAN TR·ªåNG: L√ÄM S·∫†CH TI·ªÄN ---
                    let rawPrice = item.TotalPrice;
                    let cleanPrice = 0;
                    if(typeof rawPrice === 'number') cleanPrice = rawPrice;
                    else if (typeof rawPrice === 'string') cleanPrice = parseInt(rawPrice.replace(/[^0-9]/g, '')) || 0;
const tongTien = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(cleanPrice);
                    // ------------------------------------------------

                    let statusHtml = '', actionHtml = '';
                    if (item.Status === 'Ch·ªù x√°c nh·∫≠n' || item.Status === 'ƒê√£ ƒë·∫∑t') { 
                        statusHtml = `<button onclick="updateServiceStatus(${item.ID}, 'ƒêang s·ª≠ d·ª•ng')" class="bg-yellow-100 text-yellow-700 border border-yellow-300 px-3 py-1 rounded-full text-xs font-bold hover:bg-yellow-200 transition shadow-sm flex items-center gap-1"><i class="fas fa-clock"></i> ƒê√£ ƒë·∫∑t <i class="fas fa-arrow-right ml-1 text-gray-400"></i></button>`; 
                    } else if (item.Status === 'ƒêang s·ª≠ d·ª•ng') { 
                        statusHtml = `<span class="bg-green-100 text-green-700 border border-green-300 px-3 py-1 rounded-full text-xs font-bold shadow-sm flex items-center gap-1 w-fit"><i class="fas fa-check-circle"></i> ƒêang s·ª≠ d·ª•ng</span>`; 
                        actionHtml = `<button onclick="payService(${item.ID})" class="ml-2 bg-blue-600 text-white font-bold text-xs px-3 py-1 rounded shadow hover:bg-blue-700 transition"><i class="fas fa-money-bill-wave"></i> Thanh to√°n</button>`; 
                    } else if (item.Status === 'ƒê√£ thanh to√°n') { 
                        statusHtml = `<span class="bg-gray-200 text-gray-600 px-3 py-1 rounded-full text-xs font-bold">ƒê√£ thanh to√°n</span>`; 
                    } else { 
                        statusHtml = `<span class="bg-gray-100 text-gray-600 px-2 py-1 rounded text-xs">${item.Status}</span>`; 
                    }

                    html += `<tr class="border-b hover:bg-gray-50 transition"><td class="p-4 text-gray-500 text-xs">${ngayDat}</td><td class="p-4 font-bold text-gray-800">${item.CustomerName}</td><td class="p-4">${item.CustomerPhone}</td><td class="p-4 font-semibold text-blue-600">${item.ServiceName} <span class="text-xs text-gray-400 block">${item.Note || ''}</span></td><td class="p-4 text-center font-bold">${item.Quantity}</td><td class="p-4 text-right font-bold text-red-600">${tongTien}</td><td class="p-4 text-gray-600">${ngayDung}</td><td class="p-4"><div class="flex items-center">${statusHtml} ${actionHtml}</div></td></tr>`;
                });
                tbody.innerHTML = html;
            } catch (err) { console.error(err); tbody.innerHTML = '<tr><td colspan="8" class="p-4 text-center text-red-500">L·ªói t·∫£i d·ªØ li·ªáu!</td></tr>'; }
        }

        function switchServiceTab(tab) {
            currentServiceTab = tab; const btnUnpaid = document.getElementById('btnServiceUnpaid'); const btnPaid = document.getElementById('btnServicePaid');
if (tab === 'unpaid') { btnUnpaid.className = "px-4 py-2 bg-blue-600 text-white rounded font-bold text-sm shadow transition"; btnPaid.className = "px-4 py-2 bg-white text-blue-600 border border-blue-600 rounded font-bold text-sm hover:bg-blue-50 transition"; }
            else { btnUnpaid.className = "px-4 py-2 bg-white text-blue-600 border border-blue-600 rounded font-bold text-sm hover:bg-blue-50 transition"; btnPaid.className = "px-4 py-2 bg-blue-600 text-white rounded font-bold text-sm shadow transition"; }
            loadServiceBookings();
        }

        async function updateServiceStatus(id, newStatus) { if(!confirm('Kh√°ch b·∫Øt ƒë·∫ßu s·ª≠ d·ª•ng d·ªãch v·ª• n√†y?')) return; try { const res = await fetch('http://localhost:3000/api/update-service-status', { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ id: id, status: newStatus }) }); const data = await res.json(); if(data.success) loadServiceBookings(); else alert('L·ªói c·∫≠p nh·∫≠t'); } catch(e) { alert('L·ªói k·∫øt n·ªëi'); } }
        async function payService(id) { if(!confirm('X√°c nh·∫≠n kh√°ch ƒë√£ thanh to√°n ti·ªÅn d·ªãch v·ª• n√†y?')) return; try { const res = await fetch('http://localhost:3000/api/update-service-status', { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ id: id, status: 'ƒê√£ thanh to√°n' }) }); const data = await res.json(); if(data.success) { alert('Thanh to√°n th√†nh c√¥ng!'); loadServiceBookings(); } else alert('L·ªói thanh to√°n'); } catch(e) { alert('L·ªói k·∫øt n·ªëi'); } }

        document.addEventListener('DOMContentLoaded', function() {
            showSection('dashboard');
            const form = document.getElementById('addStaffForm');
            if (form) {
                form.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    const errorMsg = document.getElementById('addStaffError'); errorMsg.textContent = '';
                    const submitBtn = e.target.querySelector('button[type="submit"]'); submitBtn.disabled = true; submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>ƒêang x·ª≠ l√Ω...';
                    const payload = { hoTen: document.getElementById('staffName').value, tenDangNhap: document.getElementById('staffUsername').value, matKhau: document.getElementById('staffPassword').value, chucVu: document.getElementById('staffRole').value, soDienThoai: document.getElementById('staffPhone').value || null, email: document.getElementById('staffEmail').value || null, queQuan: document.getElementById('staffHometown').value };
try { const res = await fetch('http://localhost:3000/api/them-nhan-vien', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }); const data = await res.json(); if (res.ok) { alert('‚úÖ ' + data.message); closeAddStaffModal(); loadStaff(); } else { errorMsg.textContent = data.message || 'L·ªói th√™m nh√¢n vi√™n!'; } } catch (err) { errorMsg.textContent = 'L·ªói k·∫øt n·ªëi server!'; } finally { submitBtn.disabled = false; submitBtn.innerHTML = '<i class="fas fa-check mr-2"></i>Th√™m Nh√¢n Vi√™n'; }
                });
            }
            const securityPassInput = document.getElementById('securityPassInput');
            if (securityPassInput) { securityPassInput.addEventListener('keypress', function(e) { if (e.key === 'Enter') { e.preventDefault(); confirmSecurityAction(); } }); }
        });

        function openAddStaffModal() { document.getElementById('add-staff-modal').classList.remove('hidden'); document.getElementById('add-staff-modal').classList.add('flex'); document.getElementById('addStaffForm').reset(); document.getElementById('addStaffError').textContent = ''; }
        function closeAddStaffModal() { document.getElementById('add-staff-modal').classList.add('hidden'); document.getElementById('add-staff-modal').classList.remove('flex'); }
        function togglePasswordVisibility(inputId) { const input = document.getElementById(inputId); const icon = document.getElementById('icon-' + inputId); if (input.type === 'password') { input.type = 'text'; icon.className = 'fas fa-eye-slash'; } else { input.type = 'password'; icon.className = 'fas fa-eye'; } }

        async function loadRevenueReport() {
            const tbody = document.getElementById('revenue-table-body');
            tbody.innerHTML = '<tr><td colspan="4" class="p-4 text-center"><i class="fas fa-spinner fa-spin"></i> ƒêang t√≠nh to√°n...</td></tr>';
            try {
                const res = await fetch('http://localhost:3000/api/doanh-thu-thang');
                const data = await res.json();
                const formatMoney = (num) => new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(num);
                const html = `
                    <tr class="border-b hover:bg-gray-50 text-lg">
                        <td class="p-4">Th√°ng ${data.thang}/${data.nam}</td>
                        <td class="p-4 text-blue-700 font-bold">${formatMoney(data.tienDichVu)}</td>
                        <td class="p-4 text-green-700 font-bold">${formatMoney(data.tienPhong)}</td>
                        <td class="p-4 text-red-600 font-bold text-xl text-right">${formatMoney(data.tongCong)}</td>
                    </tr>
                `;
                tbody.innerHTML = html;
            } catch (e) {
                console.error(e);
                tbody.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-red-500">L·ªói k·∫øt n·ªëi server!</td></tr>';
            }
        }
function maskCCCD(cccd) {
            if (!cccd || cccd.length < 4) return 'Ch∆∞a c·∫≠p nh·∫≠t';
            return cccd.substring(0, cccd.length - 4) + '****';
        }

        let allCustomerData = [];

        async function loadCustomers() {
            const tbody = document.querySelector('#customers tbody');
            tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-center"><i class="fas fa-spinner fa-spin"></i> ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>';

            try {
                const res = await fetch('http://localhost:3000/api/khach-hang');
                const data = await res.json();
                allCustomerData = data;
                renderCustomerTable(allCustomerData);
            } catch (e) {
                console.error(e);
                tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-red-500">L·ªói k·∫øt n·ªëi Server!</td></tr>';
            }
        }

        function filterCustomers() {
            const keyword = document.getElementById('searchCustomerInput').value.toLowerCase().trim();
            const filteredData = allCustomerData.filter(kh => {
                const ten = (kh.HoTen || '').toLowerCase();
                const sdt = (kh.SoDienThoai || '').toLowerCase();
                const cccd = (kh.CCCD || '').toLowerCase();
                return ten.includes(keyword) || sdt.includes(keyword) || cccd.includes(keyword);
            });
            renderCustomerTable(filteredData);
        }

        function renderCustomerTable(data) {
            const tbody = document.querySelector('#customers tbody');
            let html = '';

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="p-8 text-center text-gray-400 italic">Kh√¥ng t√¨m th·∫•y kh√°ch h√†ng ph√π h·ª£p.</td></tr>';
                return;
            }

            data.forEach(kh => {
                const chiTieu = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(kh.ChiTieu);
                const cccdDisplay = kh.CCCD && kh.CCCD.length > 5 
                    ? `<span class="font-mono text-blue-700 font-bold tracking-wider">${kh.CCCD}</span>` 
                    : '<span class="text-gray-400 text-xs italic">Ch∆∞a c·∫≠p nh·∫≠t</span>';

                let actionDisplay = '<span class="text-gray-400 italic text-xs">Ch∆∞a c√≥ l·ªãch s·ª≠</span>';
                if (kh.Phong && kh.Phong !== 'Ch∆∞a ƒë·∫∑t') {
                    actionDisplay = `
                        <button onclick="openCustomerDetail('${kh.ID}', '${kh.HoTen}')" 
                                class="text-blue-600 hover:text-blue-800 text-sm font-bold bg-blue-50 px-3 py-1 rounded-full border border-blue-200 hover:bg-blue-100 transition flex items-center w-fit">
                            <i class="fas fa-eye mr-2"></i> Xem l·ªãch s·ª≠
                        </button>
                    `;
                }

                html += `
<tr class="border-b hover:bg-gray-50 transition align-middle">
                        <td class="p-3 font-medium text-gray-800">${kh.HoTen}</td>
                        <td class="p-3">${kh.SoDienThoai || '---'}</td>
                        <td class="p-3">${cccdDisplay}</td>
                        <td class="p-3">${actionDisplay}</td>
                        <td class="p-3 font-bold text-green-700">${chiTieu}</td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;
        }

        async function openCustomerDetail(userId, userName) {
            const modal = document.getElementById('customer-detail-modal');
            const nameSpan = document.getElementById('detail-customer-name');
            const roomBody = document.getElementById('detail-room-list');
            const serviceBody = document.getElementById('detail-service-list');

            modal.classList.remove('hidden');
            modal.classList.add('flex');
            nameSpan.innerText = userName;
            roomBody.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-gray-500"><i class="fas fa-spinner fa-spin"></i> ƒêang t·∫£i l·ªãch s·ª≠ ph√≤ng...</td></tr>';
            serviceBody.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-gray-500"><i class="fas fa-spinner fa-spin"></i> ƒêang t·∫£i l·ªãch s·ª≠ d·ªãch v·ª•...</td></tr>';

            try {
                const res = await fetch(`http://localhost:3000/api/khach-hang/chi-tiet/${userId}`);
                const data = await res.json();

                const fmtMoney = (raw) => {
                    let str = String(raw).replace(/[^0-9]/g, '');
                    return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(parseInt(str) || 0);
                };
                const fmtDate = (d) => d ? new Date(d).toLocaleString('vi-VN') : '';

                if (data.rooms && data.rooms.length > 0) {
                    roomBody.innerHTML = data.rooms.map(r => `
                        <tr class="hover:bg-green-50/50 transition">
                            <td class="p-3 font-bold text-gray-700">${r.RoomName}</td>
                            <td class="p-3 text-sm text-gray-600">${fmtDate(r.CheckIn)}</td>
                            <td class="p-3 text-sm text-gray-600">${fmtDate(r.CheckOut)}</td>
                            <td class="p-3 text-right font-bold text-green-700">${fmtMoney(r.TotalPrice)}</td>
                            <td class="p-3 text-center">
                                <span class="px-2 py-1 rounded text-xs font-bold ${r.TrangThai === 'ƒê√£ thanh to√°n' ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'}">
                                    ${r.TrangThai}
                                </span>
                            </td>
                        </tr>
                    `).join('');
                } else {
roomBody.innerHTML = '<tr><td colspan="5" class="p-6 text-center text-gray-400 italic bg-gray-50">Kh√°ch ch∆∞a t·ª´ng ƒë·∫∑t ph√≤ng n√†o.</td></tr>';
                }

                if (data.services && data.services.length > 0) {
                    serviceBody.innerHTML = data.services.map(s => `
                        <tr class="hover:bg-blue-50/50 transition">
                            <td class="p-3 font-medium text-blue-700">${s.ServiceName}</td>
                            <td class="p-3 text-center font-bold">${s.Quantity}</td>
                            <td class="p-3 text-sm text-gray-600">${fmtDate(s.OrderDate)}</td>
                            <td class="p-3 text-right font-bold text-gray-700">${fmtMoney(s.TotalPrice)}</td>
                            <td class="p-3 text-center">
                                <span class="px-2 py-1 rounded text-xs font-bold ${s.Status === 'ƒê√£ thanh to√°n' ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-600'}">
                                    ${s.Status}
                                </span>
                            </td>
                        </tr>
                    `).join('');
                } else {
                    serviceBody.innerHTML = '<tr><td colspan="5" class="p-6 text-center text-gray-400 italic bg-gray-50">Kh√°ch ch∆∞a s·ª≠ d·ª•ng d·ªãch v·ª• n√†o.</td></tr>';
                }

            } catch (e) {
                console.error(e);
                alert("L·ªói t·∫£i chi ti·∫øt!");
            }
        }

        function closeCustomerDetail() {
            const modal = document.getElementById('customer-detail-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }
    </script>
</body>
</html>